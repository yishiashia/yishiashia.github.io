<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å½±é™¢è¨‚ç¥¨èˆ‡é¸ä½ç³»çµ± (WebMCP Imperative API Demo)</title>
    <!-- å¼•å…¥ @mcp-b/global polyfill -->
    <script src="https://cdn.jsdelivr.net/npm/@mcp-b/global@latest/dist/browser.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f3f4f6;
            --border-color: #374151;
            --seat-avail: #4b5563;
            --seat-booked: #ef4444;
            --seat-selected: #10b981;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
        }

        h3 {
            margin-top: 0;
            color: #e5e7eb;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #9ca3af;
        }

        select,
        input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: #374151;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .screen {
            background: linear-gradient(to bottom, #4f46e5, transparent);
            height: 30px;
            margin: 1rem 0 2rem 0;
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            line-height: 30px;
        }

        .seats-grid {
            display: grid;
            gap: 8px;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .seat {
            width: 30px;
            height: 30px;
            background-color: var(--seat-avail);
            border-radius: 6px 6px 2px 2px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            user-select: none;
        }

        .seat:hover:not(.booked) {
            background-color: #6b7280;
        }

        .seat.booked {
            background-color: var(--seat-booked);
            cursor: not-allowed;
        }

        .seat.selected {
            background-color: var(--seat-selected);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            font-size: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        button:hover {
            background-color: #4f46e5;
        }

        button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }

        .inspector {
            background-color: #0f172a;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-y: auto;
            max-height: 400px;
            color: #38bdf8;
        }

        .inspector-title {
            color: #f472b6;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .agent-log {
            background-color: #1e293b;
            border-left: 3px solid #10b981;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-family: monospace;
        }
    </style>
</head>

<body>

    <h1>ğŸŸï¸ é›»å½±é™¢è¨‚ç¥¨é¸ä½ç³»çµ±</h1>
    <p style="text-align: center; color: #9ca3af; max-width: 600px; margin: 0 auto 2rem auto;">
        æ­¤ç¯„ä¾‹å±•ç¤º <strong>WebMCP Imperative API</strong>ã€‚ä½¿ç”¨ JavaScript <code>navigator.modelContext.registerTool()</code>
        å‹•æ…‹è¨»å†Šå·¥å…·ï¼Œæ”¯æ´è¤‡é›œçš„ JSON Schema èˆ‡éåŒæ­¥äº’å‹•ã€‚
    </p>

    <div class="grid-container">
        <!-- å·¦å´ï¼šäº’å‹•ä»‹é¢ -->
        <div class="card">
            <h3>ğŸ« è¨‚ç¥¨ä»‹é¢ (äººé¡èˆ‡ UI)</h3>
            <div class="form-group">
                <label for="movieSelect">é¸æ“‡é›»å½±</label>
                <select id="movieSelect">
                    <option value="">è«‹é¸æ“‡...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="showtimeSelect">é¸æ“‡å ´æ¬¡</label>
                <select id="showtimeSelect" disabled>
                    <option value="">è«‹å…ˆé¸æ“‡é›»å½±</option>
                </select>
            </div>

            <div id="seatSelectionArea" style="display: none; margin-top: 1.5rem;">
                <div class="screen">è¢å¹• Screen</div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: var(--seat-avail)"></div> ç©ºä½
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: var(--seat-selected)"></div> å·²é¸
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: var(--seat-booked)"></div> å·²å”®å‡º
                    </div>
                </div>
                <div class="seats-grid" id="seatsGrid"></div>
                <div style="text-align: center; margin: 1rem 0; font-size: 0.9rem;">
                    å·²é¸åº§ä½: <span id="selectedSeatsList" style="color: #10b981; font-weight: bold;">ç„¡</span>
                </div>
                <button id="bookBtn" disabled>ç¢ºèªè¨‚ä½</button>
            </div>

            <div id="bookingResult"
                style="display: none; margin-top: 1rem; padding: 1rem; background-color: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; border-radius: 4px; text-align: center; color: #34d399; font-weight: bold;">
                âœ… è¨‚ç¥¨æˆåŠŸï¼ç¥æ‚¨è§€å½±æ„‰å¿«ã€‚
            </div>
        </div>

        <!-- å³å´ï¼šWebMCP å·¥å…·ç‹€æ…‹èˆ‡ Agent æ¨¡æ“¬ -->
        <div class="card">
            <h3>ğŸ› ï¸ WebMCP Tool Inspector</h3>
            <p style="font-size: 0.8rem; color: #9ca3af;">ä»¥ä¸‹æ˜¯ç¶²é é€é <code>registerTool()</code> æš´éœ²çµ¦ AI Agent çš„å·¥å…·æ¸…å–®ï¼š</p>
            <div class="inspector" id="toolInspector"></div>

            <h3 style="margin-top: 1.5rem;">ğŸ¤– æ¨¡æ“¬ Agent å¤šæ­¥é©Ÿæ“ä½œ</h3>
            <p style="font-size: 0.8rem; color: #9ca3af;">å±•ç¤º Agent å¦‚ä½•è‡ªè¡Œå‘¼å«å·¥å…·ä¾†å®Œæˆã€ŒæŸ¥è©¢é›»å½± -> æŸ¥è©¢åº§ä½ -> è¨‚ç¥¨ã€çš„å·¥ä½œæµï¼Œè€Œä¸éœ€é»æ“Šç¶²é  UIã€‚</p>
            <button id="simulateAgentBtn" style="background-color: #10b981;">â–¶ï¸ åŸ·è¡Œ Agent è¨‚ç¥¨è…³æœ¬</button>
            <div id="agentLogs" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        // --- æ¨¡æ“¬å¾Œç«¯è³‡æ–™ ---
        const DB = {
            movies: [
                { id: 'm1', title: 'æ²™ä¸˜ï¼šç¬¬äºŒéƒ¨ (Dune: Part Two)', showtimes: ['10:00', '14:30', '19:00'] },
                { id: 'm2', title: 'å¯æ†çš„æ±è¥¿ (Poor Things)', showtimes: ['11:15', '16:45', '21:30'] }
            ],
            seats: {
                'm1-10:00': ['A1', 'A2', 'C4', 'C5'], // å·²å”®å‡ºçš„åº§ä½
                'm1-14:30': ['D1', 'D2', 'D3'],
                'm1-19:00': ['E4', 'E5', 'B2', 'B3'],
                'm2-11:15': [],
                'm2-16:45': ['A1', 'B1', 'C1'],
                'm2-21:30': ['F5', 'F6']
            }
        };

        const ROWS = ['A', 'B', 'C', 'D', 'E', 'F'];
        const COLS = 6;
        let currentSelections = [];

        // --- UI é‚è¼¯ ---
        const elements = {
            movieSelect: document.getElementById('movieSelect'),
            showtimeSelect: document.getElementById('showtimeSelect'),
            seatArea: document.getElementById('seatSelectionArea'),
            seatsGrid: document.getElementById('seatsGrid'),
            bookBtn: document.getElementById('bookBtn'),
            selectedList: document.getElementById('selectedSeatsList'),
            result: document.getElementById('bookingResult'),
            inspector: document.getElementById('toolInspector')
        };

        // 1. è¼‰å…¥é›»å½±æ¸…å–®
        DB.movies.forEach(m => {
            elements.movieSelect.add(new Option(m.title, m.id));
        });

        // 2. é¸æ“‡é›»å½±å¾Œè¼‰å…¥æ™‚é–“
        elements.movieSelect.addEventListener('change', (e) => {
            elements.showtimeSelect.innerHTML = '<option value="">è«‹é¸æ“‡å ´æ¬¡</option>';
            elements.seatArea.style.display = 'none';
            elements.result.style.display = 'none';

            const movie = DB.movies.find(m => m.id === e.target.value);
            if (movie) {
                elements.showtimeSelect.disabled = false;
                movie.showtimes.forEach(t => elements.showtimeSelect.add(new Option(t, t)));
            } else {
                elements.showtimeSelect.disabled = true;
            }
        });

        // 3. é¸æ“‡å ´æ¬¡å¾Œç¹ªè£½åº§ä½è¡¨
        elements.showtimeSelect.addEventListener('change', (e) => {
            elements.result.style.display = 'none';
            if (!e.target.value) {
                elements.seatArea.style.display = 'none';
                return;
            }
            renderSeats(elements.movieSelect.value, e.target.value);
        });

        function renderSeats(movieId, time) {
            elements.seatArea.style.display = 'block';
            elements.seatsGrid.innerHTML = '';
            elements.seatsGrid.style.gridTemplateColumns = `repeat(${COLS}, 30px)`;
            currentSelections = [];
            updateSelectedUI();

            const key = `${movieId}-${time}`;
            const booked = DB.seats[key] || [];

            for (let r of ROWS) {
                for (let c = 1; c <= COLS; c++) {
                    const seatId = `${r}${c}`;
                    const isBooked = booked.includes(seatId);

                    const div = document.createElement('div');
                    div.className = `seat ${isBooked ? 'booked' : ''}`;
                    div.textContent = seatId;
                    div.dataset.id = seatId;

                    if (!isBooked) {
                        div.addEventListener('click', () => {
                            div.classList.toggle('selected');
                            if (div.classList.contains('selected')) {
                                currentSelections.push(seatId);
                            } else {
                                currentSelections = currentSelections.filter(s => s !== seatId);
                            }
                            currentSelections.sort();
                            updateSelectedUI();
                        });
                    }
                    elements.seatsGrid.appendChild(div);
                }
            }
        }

        function updateSelectedUI() {
            elements.selectedList.textContent = currentSelections.length > 0 ? currentSelections.join(', ') : 'ç„¡';
            elements.bookBtn.disabled = currentSelections.length === 0;
        }

        // è¨‚ç¥¨æŒ‰éˆ•
        elements.bookBtn.addEventListener('click', async () => {
            const movieId = elements.movieSelect.value;
            const time = elements.showtimeSelect.value;
            const key = `${movieId}-${time}`;

            // æ›´æ–° DB ä¸¦é‡ç¹ª
            if (!DB.seats[key]) DB.seats[key] = [];
            DB.seats[key].push(...currentSelections);

            elements.seatArea.style.display = 'none';
            elements.result.style.display = 'block';
            setTimeout(() => {
                elements.result.style.display = 'none';
                elements.movieSelect.value = '';
                elements.showtimeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é›»å½±</option>';
                elements.showtimeSelect.disabled = true;
            }, 3000);
        });


        // --- æ ¸å¿ƒï¼šWebMCP Imperative API è¨»å†Š ---

        // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ (æˆ–æ˜¯å¦è¢« polyfill)
        if (window.navigator && window.navigator.modelContext) {

            const toolsToRegister = [
                {
                    name: "getMovies",
                    description: "Get a list of movies currently showing and their available showtimes.",
                    inputSchema: { type: "object", properties: {} },
                    execute: async () => {
                        return { content: [{ type: "text", text: JSON.stringify(DB.movies) }] };
                    }
                },
                {
                    name: "getAvailableSeats",
                    description: "Get the seat map and availability for a specific movie and showtime.",
                    inputSchema: {
                        type: "object",
                        properties: {
                            movieId: { type: "string", description: "The ID of the movie" },
                            showtime: { type: "string", description: "The showtime string (e.g., '14:30')" }
                        },
                        required: ["movieId", "showtime"]
                    },
                    execute: async ({ movieId, showtime }) => {
                        const key = `${movieId}-${showtime}`;
                        const booked = DB.seats[key];
                        if (!booked) {
                            return { isError: true, content: [{ type: "text", text: "Invalid movie or showtime." }] };
                        }
                        return {
                            content: [{
                                type: "text",
                                text: JSON.stringify({ rows: ROWS, cols: COLS, bookedSeats: booked })
                            }]
                        };
                    }
                },
                {
                    name: "bookTickets",
                    description: "Book specific seats for a movie. Use getAvailableSeats first to ensure seats are empty.",
                    inputSchema: {
                        type: "object",
                        properties: {
                            movieId: { type: "string" },
                            showtime: { type: "string" },
                            seats: {
                                type: "array",
                                items: { type: "string" },
                                description: "Array of seat codes to book, e.g. ['C3', 'C4']"
                            }
                        },
                        required: ["movieId", "showtime", "seats"]
                    },
                    execute: async ({ movieId, showtime, seats }) => {
                        const key = `${movieId}-${showtime}`;
                        if (!DB.seats[key]) return { isError: true, content: [{ type: "text", text: "Invalid session." }] };

                        // é©—è­‰æ˜¯å¦å·²è¢«è¨‚ä½
                        const conflict = seats.find(s => DB.seats[key].includes(s));
                        if (conflict) {
                            return { isError: true, content: [{ type: "text", text: `Seat ${conflict} is already booked!` }] };
                        }

                        // åŸ·è¡Œè¨‚ä½
                        DB.seats[key].push(...seats);

                        // åŒæ­¥æ›´æ–° UI ä»¥å±•ç¤º Agent çš„æ“ä½œèƒ½å½±éŸ¿ç•«é¢
                        if (elements.movieSelect.value === movieId && elements.showtimeSelect.value === showtime) {
                            renderSeats(movieId, showtime);
                        }

                        return {
                            content: [{ type: "text", text: `Successfully booked tickets for ${seats.join(', ')}.` }]
                        };
                    }
                }
            ];

            // è¨»å†Šå·¥å…·ä¸¦é¡¯ç¤ºåœ¨ Inspector å…§
            toolsToRegister.forEach(tool => {
                window.navigator.modelContext.registerTool(tool);

                const div = document.createElement('div');
                div.style.marginBottom = '1.5rem';
                div.innerHTML = `
          <div class="inspector-title">ğŸ”§ ${tool.name}</div>
          <div style="color: #94a3b8; margin-bottom: 0.5rem;">${tool.description}</div>
          <div>Schema: ${JSON.stringify(tool.inputSchema, null, 2).replace(/\n/g, '<br>&nbsp;&nbsp;')}</div>
        `;
                elements.inspector.appendChild(div);
            });

        } else {
            elements.inspector.innerHTML = '<span style="color:#ef4444">æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ navigator.modelContextã€‚è«‹ç¢ºèªå·²è¼‰å…¥ polyfill æˆ–ä½¿ç”¨æ”¯æ´çš„ç€è¦½å™¨ä¸¦é–‹å•Ÿ flagã€‚</span>';
        }


        // --- æ¨¡æ“¬ Agent è¡Œç‚º ---
        document.getElementById('simulateAgentBtn').addEventListener('click', async () => {
            const logs = document.getElementById('agentLogs');
            logs.innerHTML = '';
            const log = (msg) => {
                const div = document.createElement('div');
                div.className = 'agent-log';
                div.textContent = `> ${msg}`;
                logs.appendChild(div);
            };

            document.getElementById('simulateAgentBtn').disabled = true;

            // Agent æ€è€ƒæµç¨‹æ¨¡æ“¬
            log("Agent: 'ä½¿ç”¨è€…æƒ³è¦è¨‚ 2 å¼µæ²™ä¸˜æ™šä¸Šçš„ç¥¨ã€‚è®“æˆ‘å…ˆæŸ¥ä¸€ä¸‹é›»å½±æ¸…å–®...'");
            log("èª¿ç”¨å·¥å…·: getMovies()");

            // æ•…æ„å»¶é²ç‡Ÿé€ çœŸå¯¦æ„Ÿ
            await new Promise(r => setTimeout(r, 1000));

            const moviesDump = JSON.stringify(DB.movies.map(m => m.title));
            log(`å¾—åˆ°çµæœ: ${moviesDump}`);
            log("Agent: 'æ²™ä¸˜çš„ ID æ˜¯ m1ï¼Œæ™šä¸Šçš„å ´æ¬¡æ˜¯ 19:00ã€‚æˆ‘è¦æŸ¥ä¸€ä¸‹å‰©é¤˜åº§ä½...'");

            // å¹«ä½¿ç”¨è€…æ“ä½œ UI (é€™åªæ˜¯è¦–è¦ºæ•ˆæœï¼Œå¯¦éš›ä¸Š Agent åœ¨èƒŒæ™¯ API åš)
            elements.movieSelect.value = 'm1';
            elements.movieSelect.dispatchEvent(new Event('change'));

            await new Promise(r => setTimeout(r, 1000));
            log("èª¿ç”¨å·¥å…·: getAvailableSeats({ movieId: 'm1', showtime: '19:00' })");

            elements.showtimeSelect.value = '19:00';
            elements.showtimeSelect.dispatchEvent(new Event('change'));

            await new Promise(r => setTimeout(r, 1000));
            const booked = DB.seats['m1-19:00'];
            log(`å¾—åˆ°çµæœ: å·²å”®å‡º [${booked.join(', ')}]`);
            log("Agent: 'E4, E5 è³£æ‰äº†ï¼Œé‚£æˆ‘å¹«ä»–è¨‚ E1, E2 å¥½äº†ã€‚'");

            await new Promise(r => setTimeout(r, 1500));
            log("èª¿ç”¨å·¥å…·: bookTickets({ movieId: 'm1', showtime: '19:00', seats: ['E1', 'E2'] })");

            // ç›´æ¥ä¿®æ”¹åº•å±¤è³‡æ–™ä¾†æ¨¡æ“¬ Agent é€šé API book æˆåŠŸ
            DB.seats['m1-19:00'].push('E1', 'E2');
            // å¼·åˆ¶ UI é‡ç¹ª
            renderSeats('m1', '19:00');

            await new Promise(r => setTimeout(r, 800));
            log("å¾—åˆ°çµæœ: Successfully booked tickets for E1, E2.");
            log("Agent: ä»»å‹™å®Œæˆï¼å·²ç‚ºæ‚¨æˆåŠŸè¨‚äº†æ²™ä¸˜ 19:00 çš„ E1, E2 åº§ä½ã€‚");

            elements.result.style.display = 'block';
            setTimeout(() => {
                elements.result.style.display = 'none';
                document.getElementById('simulateAgentBtn').disabled = false;
            }, 5000);
        });
    </script>
</body>

</html>