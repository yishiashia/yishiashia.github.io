<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>使用 CoreDNS 自建 DNS Server | yishiashia&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="這陣子在研究自行建設 Postfix Mail Server，發現要架設一個 Mail Server 沒有想像中的容易，除了需要透過 DNS 記錄設定網域的 A 記錄、 MX 記錄之外，另外需要 DNS 設定 SPF, DKIM, DMARC 等安全性設定。
在設定的過程中很快的遇到了瓶頸，一般的網域服務諸如 HiDomain、GoDaddy 等平台都有代管 DNS 記錄的上限，像我使用的 HiDomain 就有最多設定 20 筆記錄的上限，因為在不同專案已經註冊了許多子網域，這次要架設一個 Mail Server 時我很快就碰到了 DNS 記錄的代管上限，後來決定使用在 Kubernetes (k8s) 中經常使用的輕量 DNS Server CoreDNS 來自建 DNS Server。
Photo by Markus Winkler on Unsplash
關於 CoreDNS CoreDNS 是雲原生運算基金會 (Cloud Native Computing Foundation, 簡稱 CNCF)的一項專案，並於 2019 年畢業。
CoreDNS 主要使用 Go 語言實做，所以可以安裝於不同平台並且相當輕量不會佔用太多系統的資源，同時在設定上非常簡單，透過使用 corefile ，可以很簡單的引入各種 plugin，很大程度地減少設定上的複雜度，接下來就實際進入安裝與使用的介紹。
安裝 CoreDNS 官網上提供了三種安裝方式， Binaries 、 Source 及 Docker。">
<meta name="author" content="">
<link rel="canonical" href="https://yishiashia.github.io/posts/self-hosted-dns-with-coredns/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3e218dd9b3bab3f2ebac3f658027d6c4c9641e6641fee2ab61ee5861491ca923.css" integrity="sha256-PiGN2bO6s/LrrD9lgCfWxMlkHmZB/uKrYe5YYUkcqSM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://yishiashia.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://yishiashia.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yishiashia.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://yishiashia.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://yishiashia.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="使用 CoreDNS 自建 DNS Server" />
<meta property="og:description" content="這陣子在研究自行建設 Postfix Mail Server，發現要架設一個 Mail Server 沒有想像中的容易，除了需要透過 DNS 記錄設定網域的 A 記錄、 MX 記錄之外，另外需要 DNS 設定 SPF, DKIM, DMARC 等安全性設定。
在設定的過程中很快的遇到了瓶頸，一般的網域服務諸如 HiDomain、GoDaddy 等平台都有代管 DNS 記錄的上限，像我使用的 HiDomain 就有最多設定 20 筆記錄的上限，因為在不同專案已經註冊了許多子網域，這次要架設一個 Mail Server 時我很快就碰到了 DNS 記錄的代管上限，後來決定使用在 Kubernetes (k8s) 中經常使用的輕量 DNS Server CoreDNS 來自建 DNS Server。
Photo by Markus Winkler on Unsplash
關於 CoreDNS CoreDNS 是雲原生運算基金會 (Cloud Native Computing Foundation, 簡稱 CNCF)的一項專案，並於 2019 年畢業。
CoreDNS 主要使用 Go 語言實做，所以可以安裝於不同平台並且相當輕量不會佔用太多系統的資源，同時在設定上非常簡單，透過使用 corefile ，可以很簡單的引入各種 plugin，很大程度地減少設定上的複雜度，接下來就實際進入安裝與使用的介紹。
安裝 CoreDNS 官網上提供了三種安裝方式， Binaries 、 Source 及 Docker。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yishiashia.github.io/posts/self-hosted-dns-with-coredns/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-15T15:25:41+08:00" />
<meta property="article:modified_time" content="2022-08-15T15:25:41+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 CoreDNS 自建 DNS Server"/>
<meta name="twitter:description" content="這陣子在研究自行建設 Postfix Mail Server，發現要架設一個 Mail Server 沒有想像中的容易，除了需要透過 DNS 記錄設定網域的 A 記錄、 MX 記錄之外，另外需要 DNS 設定 SPF, DKIM, DMARC 等安全性設定。
在設定的過程中很快的遇到了瓶頸，一般的網域服務諸如 HiDomain、GoDaddy 等平台都有代管 DNS 記錄的上限，像我使用的 HiDomain 就有最多設定 20 筆記錄的上限，因為在不同專案已經註冊了許多子網域，這次要架設一個 Mail Server 時我很快就碰到了 DNS 記錄的代管上限，後來決定使用在 Kubernetes (k8s) 中經常使用的輕量 DNS Server CoreDNS 來自建 DNS Server。
Photo by Markus Winkler on Unsplash
關於 CoreDNS CoreDNS 是雲原生運算基金會 (Cloud Native Computing Foundation, 簡稱 CNCF)的一項專案，並於 2019 年畢業。
CoreDNS 主要使用 Go 語言實做，所以可以安裝於不同平台並且相當輕量不會佔用太多系統的資源，同時在設定上非常簡單，透過使用 corefile ，可以很簡單的引入各種 plugin，很大程度地減少設定上的複雜度，接下來就實際進入安裝與使用的介紹。
安裝 CoreDNS 官網上提供了三種安裝方式， Binaries 、 Source 及 Docker。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://yishiashia.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "使用 CoreDNS 自建 DNS Server",
      "item": "https://yishiashia.github.io/posts/self-hosted-dns-with-coredns/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "使用 CoreDNS 自建 DNS Server",
  "name": "使用 CoreDNS 自建 DNS Server",
  "description": "這陣子在研究自行建設 Postfix Mail Server，發現要架設一個 Mail Server 沒有想像中的容易，除了需要透過 DNS 記錄設定網域的 A 記錄、 MX 記錄之外，另外需要 DNS 設定 SPF, DKIM, DMARC 等安全性設定。\n在設定的過程中很快的遇到了瓶頸，一般的網域服務諸如 HiDomain、GoDaddy 等平台都有代管 DNS 記錄的上限，像我使用的 HiDomain 就有最多設定 20 筆記錄的上限，因為在不同專案已經註冊了許多子網域，這次要架設一個 Mail Server 時我很快就碰到了 DNS 記錄的代管上限，後來決定使用在 Kubernetes (k8s) 中經常使用的輕量 DNS Server CoreDNS 來自建 DNS Server。\nPhoto by Markus Winkler on Unsplash\n關於 CoreDNS CoreDNS 是雲原生運算基金會 (Cloud Native Computing Foundation, 簡稱 CNCF)的一項專案，並於 2019 年畢業。\nCoreDNS 主要使用 Go 語言實做，所以可以安裝於不同平台並且相當輕量不會佔用太多系統的資源，同時在設定上非常簡單，透過使用 corefile ，可以很簡單的引入各種 plugin，很大程度地減少設定上的複雜度，接下來就實際進入安裝與使用的介紹。\n安裝 CoreDNS 官網上提供了三種安裝方式， Binaries 、 Source 及 Docker。",
  "keywords": [
    
  ],
  "articleBody": "這陣子在研究自行建設 Postfix Mail Server，發現要架設一個 Mail Server 沒有想像中的容易，除了需要透過 DNS 記錄設定網域的 A 記錄、 MX 記錄之外，另外需要 DNS 設定 SPF, DKIM, DMARC 等安全性設定。\n在設定的過程中很快的遇到了瓶頸，一般的網域服務諸如 HiDomain、GoDaddy 等平台都有代管 DNS 記錄的上限，像我使用的 HiDomain 就有最多設定 20 筆記錄的上限，因為在不同專案已經註冊了許多子網域，這次要架設一個 Mail Server 時我很快就碰到了 DNS 記錄的代管上限，後來決定使用在 Kubernetes (k8s) 中經常使用的輕量 DNS Server CoreDNS 來自建 DNS Server。\nPhoto by Markus Winkler on Unsplash\n關於 CoreDNS CoreDNS 是雲原生運算基金會 (Cloud Native Computing Foundation, 簡稱 CNCF)的一項專案，並於 2019 年畢業。\nCoreDNS 主要使用 Go 語言實做，所以可以安裝於不同平台並且相當輕量不會佔用太多系統的資源，同時在設定上非常簡單，透過使用 corefile ，可以很簡單的引入各種 plugin，很大程度地減少設定上的複雜度，接下來就實際進入安裝與使用的介紹。\n安裝 CoreDNS 官網上提供了三種安裝方式， Binaries 、 Source 及 Docker。\nBinaries 是已經預先編譯好的可執行檔，可以透過官方的連結去下載使用。\nSource 則是下載最新版本的 CoreDNS 原始碼自行編譯成可執行檔。\n最後一種安裝方式是透過官方在 DockerＨub 上所提供的 Docker image 去安裝與建置 CoreDNS，也是我選擇的安裝方式。\ndocker pull coredns/coredns ▲使用上面指令可以下載最新版本的 docker image\n實務上為了後續維運上的方便，我通常在使用 docker image 時會指定特定版本號，避免後續因為意料外的版本更新造成服務異常。\ndocker pull coredns/coredns:1.9.3 ▲加上版本號標籤指定使用特定版本的 docker image\n下載完 Docker image 後，可以嘗試啟動 Docker container:\ndocker run --it --rm -p 53:53/udp coredns/coredns:1.9.3 啟動後，我們可以使用下列指令測試服務是否正常\ndig @127.0.0.1 a whoami.example.org 如果可以看到如下的回覆代表 DNS Server 已成功安裝：\n; \u003c\u003c\u003e\u003e DiG 9.10.3-P4-Ubuntu \u003c\u003c\u003e\u003e @127.0.0.1 a whoami.example.org ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NXDOMAIN, id: 56921 ;; flags: qr rd ra ad; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;whoami.example.org. IN A ;; AUTHORITY SECTION: example.org. 2340 IN SOA ns.icann.org. noc.dns.icann.org. 2022072112 7200 3600 1209600 3600 ;; Query time: 5 msec ;; SERVER: 127.0.0.1#53(127.0.0.1) ;; WHEN: Mon Aug 15 11:39:36 CST 2022 ;; MSG SIZE rcvd: 123 使用 Corefile 設定 DNS 紀錄 回到最原本的需求，我是要建立一個 DNS Server 來管理自己網域的相關 DNS 紀錄，那接下來我就示範如何透過 Corefile 來設定自己網域的相關 DNS 紀錄。\nCoreDNS 有許多外掛模組可以用，那我這邊用到的是 file 這個 plugin，讓 CoreDNS 可以讀取我們設定好的 zone file。\nCorefile:\n.:53 { forward . 8.8.8.8 9.9.9.9 log errors } example.org:53 { file /cfg/example.org log errors } CoreDNS 使用 greedy match policy 來選擇最為匹配的 DNS 設定，上方的 Corefile 中我們可以看到兩個區塊，一個是 .:53，表示 wildcard 的域名 query，下面的是 example.org:53 ，表示跟 example.org 相關的域名請求會跑到這個區塊。\n以下說明相關設定：\nfile /cfg/example.org 這行指令是說透過 file 這個外掛模組去讀取 /cfg/example.org 這個 zone file 設定檔。 log 是指儲存 DNS query log。 errors 是指儲存 error log。 完成 Corefile 設定後，我們就可以開始著手來管理自己域名的 DNS 紀錄啦，可以在設定檔目錄裡面新增一個 example.org (實際設定可依照您自己註冊的域名去做替換)\nexample.org:\nexample.org. IN SOA dns.example.org. admin.example.org. 2022081321 7200 3600 1209600 3600 example.org. IN A 10.0.0.1 dns.example.org. IN A 10.0.0.1 mail.example.org. IN A 10.0.0.1 example.org. IN MX 10 mail.example.org 設定檔案目錄結構:\n/home//coredns ├── Corefile └── example.org 在完成設定檔後，重新啟動 CoreDNS Docker container:\ndocker run -itd --rm --name=dns1 \\ -v /home//coredns:/cfg \\ -p 53:53/udp \\ -p 53:53/tcp \\ coredns/coredns:1.9.3 -conf /cfg/Corefile 然後使用 dig 指令測試您的 DNS Server\ndig @127.0.0.1 A mail.example.org 壓力測試 安裝完 DNS Server 之後，使用 dnsperf 這項工具來壓力測試一下，在我所租用的 1 cpu、2G ram 的小型主機上可以得到大約 6,000 qps 的處理效能，看起來挺棒的:\n測試命令:\n$ dnsperf -s 127.0.0.1 -d queryfile -l 30 -c 20 -Q 10000 結果:\nDNS Performance Testing Tool Version 2.9.0 [Status] Command line: dnsperf -s 127.0.0.1 -d queryfile -l 30 -c 20 -Q 10000 [Status] Sending queries (to 127.0.0.1:53) [Status] Started at: Mon Aug 15 12:46:47 2022 [Status] Stopping after 30.000000 seconds [Status] Testing complete (time limit) Statistics: Queries sent: 187027 Queries completed: 187027 (100.00%) Queries lost: 0 (0.00%) Response codes: NOERROR 187027 (100.00%) Average packet size: request 38, response 74 Run time (s): 30.018232 Queries per second: 6230.446883 Average Latency (s): 0.015878 (min 0.000180, max 0.217620) Latency StdDev (s): 0.010163 域名代管平台設定 在完成並測試自建 DNS Sever 後，我們就可以將域名代管平台的 DNS 主機設定為我們自建的 DNS Server，以 HiDomain 為例，登入後我們可以點選 “我的網域” 進入網域資訊頁面，然後點選 “更新DNS主機”，將我們自建的 DNS Server 的 IPv4 及 IPv6 位址 (如果有的話) 輸入頁面後按下儲存即可。\n以上就完成了一個簡單的 DNS Sever !\n",
  "wordCount" : "511",
  "inLanguage": "en",
  "datePublished": "2022-08-15T15:25:41+08:00",
  "dateModified": "2022-08-15T15:25:41+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yishiashia.github.io/posts/self-hosted-dns-with-coredns/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "yishiashia's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://yishiashia.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://yishiashia.github.io/" accesskey="h" title="yishiashia (Alt + H)">
                    <svg version='1.0' xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 464.000000 466.000000' preserveAspectRatio='xMidYMid meet'><g transform='translate(0.000000,466.000000) scale(0.100000,-0.100000)' fill='currentColor' stroke='none'><path d='M300 4473 c-56 -24 -98 -61 -123 -106 -20 -38 -22 -56 -21 -172 0 -100 5 -148 22 -208 12 -43 23 -81 26 -85 3 -5 7 -20 10 -34 6 -35 75 -233 92 -266 8 -15 14 -36 14 -48 0 -22 33 -108 82 -214 16 -36 39 -90 50 -120 11 -30 26 -62 33 -70 7 -8 20 -32 28 -52 9 -20 36 -68 61 -107 26 -39 50 -81 56 -95 5 -14 35 -60 67 -102 32 -42 67 -89 78 -105 11 -15 47 -50 81 -78 33 -27 61 -56 61 -63 2 -57 25 -264 33 -308 6 -30 13 -70 16 -88 2 -18 9 -42 14 -53 6 -10 15 -45 21 -76 6 -32 17 -71 24 -88 7 -16 21 -50 30 -75 9 -25 25 -65 35 -90 l18 -46 -77 -39 c-49 -26 -94 -59 -125 -93 -28 -30 -63 -60 -78 -68 -15 -8 -39 -31 -53 -52 -14 -20 -45 -62 -70 -92 -69 -85 -173 -304 -195 -410 -7 -30 -15 -68 -18 -85 -4 -16 -7 -95 -7 -175 1 -132 3 -152 29 -228 15 -45 31 -82 35 -82 4 0 27 -27 52 -60 36 -50 56 -67 114 -94 39 -19 88 -39 110 -45 44 -12 886 -16 994 -5 l61 7 0 98 0 99 -140 0 -140 0 0 406 0 406 23 -14 c12 -8 40 -21 62 -28 22 -7 57 -24 79 -37 55 -35 240 -98 257 -87 4 2 10 0 13 -5 14 -21 295 -37 406 -22 151 20 333 72 393 114 43 30 147 68 148 54 3 -62 4 -694 1 -734 l-4 -52 -151 -3 -152 -3 -3 -74 c-3 -69 -1 -76 24 -102 l28 -29 193 0 c154 0 200 3 223 15 61 32 60 21 60 618 l0 544 23 25 c151 167 251 308 299 421 16 40 39 91 49 113 49 110 83 290 95 504 7 119 8 120 107 197 31 24 57 50 57 57 0 7 27 44 60 82 33 38 63 80 66 94 4 14 18 41 33 60 29 38 141 232 141 244 0 4 25 59 55 121 30 63 55 117 55 120 0 3 8 24 19 48 10 23 29 76 41 117 13 41 28 84 35 96 7 11 21 49 31 85 10 35 29 93 42 129 48 132 54 162 55 290 1 142 -9 190 -53 238 -75 82 -188 102 -321 58 -91 -30 -223 -88 -304 -134 -91 -52 -124 -74 -128 -85 -3 -7 -23 -19 -46 -27 -22 -7 -49 -22 -58 -33 -10 -10 -27 -23 -38 -27 -11 -5 -62 -40 -114 -79 -84 -63 -167 -150 -230 -238 -12 -18 -31 -33 -41 -33 -10 0 -40 18 -66 41 -47 38 -220 129 -247 129 -7 0 -17 4 -23 9 -8 8 -160 51 -194 56 -8 1 -24 5 -35 10 -11 5 -114 10 -230 10 -219 0 -293 -3 -310 -14 -5 -4 -23 -8 -40 -10 -35 -4 -231 -68 -260 -85 -11 -7 -39 -18 -62 -24 -22 -7 -63 -27 -90 -45 -73 -50 -78 -51 -114 -9 -36 41 -200 178 -279 232 -28 19 -73 52 -101 73 -28 20 -56 37 -63 37 -6 0 -51 27 -100 60 -49 33 -98 62 -108 66 -10 3 -18 9 -18 14 0 4 -12 11 -27 15 -16 3 -47 15 -70 26 -24 10 -62 28 -86 38 -112 51 -236 65 -307 34z m3934 -209 c16 -22 18 -37 12 -98 -7 -88 -10 -109 -18 -121 -3 -6 -9 -26 -12 -45 -4 -19 -11 -46 -16 -60 -5 -14 -16 -52 -26 -85 -10 -33 -23 -69 -30 -80 -6 -11 -17 -45 -24 -75 -7 -30 -18 -65 -26 -77 -8 -12 -14 -29 -14 -36 0 -8 -20 -55 -45 -106 -25 -50 -45 -96 -45 -101 0 -17 -78 -176 -113 -231 -19 -30 -48 -81 -65 -115 -17 -33 -41 -73 -54 -88 -66 -79 -77 -90 -78 -76 -2 37 -35 238 -43 260 -3 8 -11 33 -17 55 -7 22 -35 90 -63 150 -41 90 -68 130 -144 220 -51 61 -93 116 -93 123 0 31 43 92 105 147 36 33 79 72 95 87 16 15 46 35 67 43 21 9 49 26 63 39 31 28 123 86 137 86 6 0 33 15 61 33 111 72 172 106 197 107 11 1 52 16 90 35 39 18 72 34 75 34 3 0 13 -11 24 -25z m-3733 -14 c41 -16 77 -30 82 -30 4 0 51 -26 105 -57 53 -31 124 -70 157 -87 33 -17 94 -56 135 -87 42 -31 87 -62 100 -69 44 -23 153 -120 224 -199 18 -20 18 -21 -37 -81 -31 -33 -68 -77 -83 -98 -15 -20 -42 -53 -59 -72 -18 -19 -40 -57 -50 -84 -10 -27 -28 -65 -41 -83 -12 -19 -26 -48 -30 -66 -3 -18 -17 -54 -29 -82 -23 -50 -53 -185 -57 -260 l-3 -40 -35 48 c-19 27 -47 63 -61 80 -15 18 -30 43 -34 57 -4 14 -31 66 -61 116 -30 51 -54 95 -54 99 0 4 -7 21 -15 38 -8 18 -24 57 -35 87 -12 30 -26 60 -32 67 -5 7 -21 43 -35 80 -35 95 -74 206 -77 218 -1 6 -7 20 -14 32 -7 12 -15 44 -19 70 -3 26 -9 53 -13 58 -4 6 -22 68 -40 138 -32 130 -34 175 -7 218 16 26 33 24 118 -11z m2079 -416 c153 -37 231 -66 334 -125 117 -67 180 -116 261 -204 73 -78 185 -224 185 -241 0 -12 34 -96 51 -127 9 -17 41 -138 60 -227 10 -46 14 -448 5 -457 -3 -3 -18 6 -33 21 -89 83 -124 103 -219 126 -119 29 -198 19 -314 -38 -44 -21 -132 -104 -150 -140 -8 -15 -19 -34 -26 -42 -42 -55 -57 -221 -29 -317 20 -66 31 -87 85 -156 93 -120 287 -184 438 -144 31 8 28 -3 -13 -43 -19 -19 -35 -41 -35 -49 0 -24 -180 -190 -278 -257 -52 -35 -112 -69 -135 -75 -23 -6 -46 -14 -52 -18 -17 -13 -130 -51 -178 -60 l-45 -8 21 41 c12 23 27 47 34 54 7 7 13 19 13 27 0 7 7 26 15 41 28 54 37 129 25 191 -21 101 -127 201 -230 219 -65 10 -123 12 -135 4 -5 -3 -21 -7 -33 -8 -70 -3 -188 -112 -209 -191 -7 -25 -13 -61 -13 -79 0 -63 38 -167 86 -237 19 -27 18 -55 -3 -55 -16 0 -108 31 -233 78 -56 21 -167 93 -239 155 -30 26 -58 47 -61 47 -4 0 -23 21 -44 47 -20 27 -59 77 -87 112 -27 35 -48 65 -46 67 2 3 17 0 33 -6 71 -27 213 -1 306 57 21 13 42 23 46 23 10 0 102 114 102 125 0 4 8 19 19 33 48 68 53 273 8 354 -38 70 -43 77 -78 116 -94 102 -188 146 -314 146 -102 0 -207 -34 -250 -79 -21 -23 -87 -67 -92 -62 -8 9 -9 346 -1 405 17 119 39 198 85 300 12 29 23 57 23 63 0 18 29 67 67 112 21 25 52 64 68 87 36 51 138 151 185 184 117 80 199 126 263 146 39 13 77 26 82 30 11 8 73 23 77 19 2 -1 12 3 23 9 20 10 42 14 165 33 96 14 294 1 410 -27z m-1049 -1448 c54 -19 116 -74 133 -117 18 -45 20 -108 5 -162 -12 -45 -79 -112 -127 -128 -52 -17 -130 -6 -195 26 -71 36 -87 65 -95 163 -4 64 -2 79 18 115 25 45 28 47 99 89 51 30 105 35 162 14z m1686 -12 c99 -52 123 -88 123 -182 0 -47 -25 -129 -47 -154 -40 -44 -180 -89 -209 -66 -7 5 -16 7 -20 6 -5 -2 -33 12 -62 30 -114 70 -136 228 -43 320 73 73 173 91 258 46z m-878 -739 c34 -17 41 -32 41 -93 0 -59 -17 -93 -53 -105 -41 -13 -75 -1 -97 36 -25 40 -25 86 -3 126 29 49 65 61 112 36z m-976 -234 l27 -33 0 -484 0 -484 -267 0 c-193 0 -275 4 -292 13 -45 22 -108 111 -120 169 -24 112 -15 285 17 368 5 14 9 27 9 30 0 3 9 23 20 45 12 22 26 58 32 80 18 67 137 226 221 296 41 34 78 66 81 71 3 5 34 23 70 42 l64 33 55 -57 c30 -31 67 -71 83 -89z'/></g></svg>yishiashia</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://yishiashia.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      使用 CoreDNS 自建 DNS Server
    </h1>
    <div class="post-meta"><span title='2022-08-15 15:25:41 +0800 CST'>August 15, 2022</span>

</div>
  </header> 
  <div class="post-content"><p>這陣子在研究自行建設 Postfix Mail Server，發現要架設一個 Mail Server 沒有想像中的容易，除了需要透過 DNS 記錄設定網域的 A 記錄、 MX 記錄之外，另外需要 DNS 設定 SPF, DKIM, DMARC 等安全性設定。</p>
<p>在設定的過程中很快的遇到了瓶頸，一般的網域服務諸如 HiDomain、GoDaddy 等平台都有代管 DNS 記錄的上限，像我使用的 HiDomain 就有最多設定 20 筆記錄的上限，因為在不同專案已經註冊了許多子網域，這次要架設一個 Mail Server 時我很快就碰到了 DNS 記錄的代管上限，後來決定使用在 Kubernetes (k8s) 中經常使用的輕量 DNS Server CoreDNS 來自建 DNS Server。</p>
<p><img loading="lazy" src="/images/0_bBPydoEQM7H452gu.jpeg" alt=""  />

<em>Photo by <a href="https://unsplash.com/@markuswinkler">Markus Winkler</a> on <a href="https://unsplash.com/">Unsplash</a></em></p>
<hr>
<h2 id="關於-coredns">關於 CoreDNS<a hidden class="anchor" aria-hidden="true" href="#關於-coredns">#</a></h2>
<p>CoreDNS 是雲原生運算基金會 (Cloud Native Computing Foundation, 簡稱 CNCF)的一項專案，並於 2019 年畢業。</p>
<p>CoreDNS 主要使用 Go 語言實做，所以可以安裝於不同平台並且相當輕量不會佔用太多系統的資源，同時在設定上非常簡單，透過使用 corefile ，可以很簡單的引入各種 plugin，很大程度地減少設定上的複雜度，接下來就實際進入安裝與使用的介紹。</p>
<hr>
<h2 id="安裝-coredns">安裝 CoreDNS<a hidden class="anchor" aria-hidden="true" href="#安裝-coredns">#</a></h2>
<p>官網上提供了三種安裝方式， <code>Binaries</code> 、 <code>Source</code> 及 <code>Docker</code>。</p>
<p><code>Binaries</code> 是已經預先編譯好的可執行檔，可以透過官方的連結去下載使用。</p>
<p><code>Source</code> 則是下載最新版本的 CoreDNS 原始碼自行編譯成可執行檔。</p>
<p>最後一種安裝方式是透過官方在 <code>DockerＨub</code> 上所提供的 Docker image 去安裝與建置 CoreDNS，也是我選擇的安裝方式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull coredns/coredns
</span></span></code></pre></div><p><em>▲使用上面指令可以下載最新版本的 docker image</em></p>
<p>實務上為了後續維運上的方便，我通常在使用 docker image 時會指定特定版本號，避免後續因為意料外的版本更新造成服務異常。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull coredns/coredns:1.9.3
</span></span></code></pre></div><p><em>▲加上版本號標籤指定使用特定版本的 docker image</em></p>
<p>下載完 Docker image 後，可以嘗試啟動 Docker container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker run --it --rm -p 53:53/udp coredns/coredns:1.9.3
</span></span></code></pre></div><p>啟動後，我們可以使用下列指令測試服務是否正常</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>dig @127.0.0.1 a whoami.example.org
</span></span></code></pre></div><p>如果可以看到如下的回覆代表 DNS Server 已成功安裝：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 a whoami.example.org
</span></span><span style="display:flex;"><span>; (1 server found)
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>;; Got answer:
</span></span><span style="display:flex;"><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 56921
</span></span><span style="display:flex;"><span>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1
</span></span><span style="display:flex;"><span>;; OPT PSEUDOSECTION:
</span></span><span style="display:flex;"><span>; EDNS: version: 0, flags:; udp: 4096
</span></span><span style="display:flex;"><span>;; QUESTION SECTION:
</span></span><span style="display:flex;"><span>;whoami.example.org.  IN A
</span></span><span style="display:flex;"><span>;; AUTHORITY SECTION:
</span></span><span style="display:flex;"><span>example.org.  2340 IN SOA ns.icann.org. noc.dns.icann.org. 2022072112 7200 3600 1209600 3600
</span></span><span style="display:flex;"><span>;; Query time: 5 msec
</span></span><span style="display:flex;"><span>;; SERVER: 127.0.0.1#53(127.0.0.1)
</span></span><span style="display:flex;"><span>;; WHEN: Mon Aug 15 11:39:36 CST 2022
</span></span><span style="display:flex;"><span>;; MSG SIZE  rcvd: 123
</span></span></code></pre></div><hr>
<h2 id="使用-corefile-設定-dns-紀錄">使用 Corefile 設定 DNS 紀錄<a hidden class="anchor" aria-hidden="true" href="#使用-corefile-設定-dns-紀錄">#</a></h2>
<p>回到最原本的需求，我是要建立一個 DNS Server 來管理自己網域的相關 DNS 紀錄，那接下來我就示範如何透過 Corefile 來設定自己網域的相關 DNS 紀錄。</p>
<p>CoreDNS 有許多外掛模組可以用，那我這邊用到的是 file 這個 plugin，讓 CoreDNS 可以讀取我們設定好的 zone file。</p>
<p>Corefile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>.:53 {
</span></span><span style="display:flex;"><span>     forward . 8.8.8.8 9.9.9.9
</span></span><span style="display:flex;"><span>     log
</span></span><span style="display:flex;"><span>     errors
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>example.org:53 {
</span></span><span style="display:flex;"><span>     file /cfg/example.org
</span></span><span style="display:flex;"><span>     log
</span></span><span style="display:flex;"><span>     errors
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>CoreDNS 使用 greedy match policy 來選擇最為匹配的 DNS 設定，上方的 Corefile 中我們可以看到兩個區塊，一個是 <code>.:53</code>，表示 wildcard 的域名 query，下面的是 <code>example.org:53</code> ，表示跟 <code>example.org</code> 相關的域名請求會跑到這個區塊。</p>
<p>以下說明相關設定：</p>
<ul>
<li><code>file /cfg/example.org</code> 這行指令是說透過 <code>file</code> 這個外掛模組去讀取 <code>/cfg/example.org</code> 這個 zone file 設定檔。</li>
<li><code>log</code> 是指儲存 DNS query log。</li>
<li><code>errors</code> 是指儲存 error log。</li>
</ul>
<p>完成 <code>Corefile</code> 設定後，我們就可以開始著手來管理自己域名的 DNS 紀錄啦，可以在設定檔目錄裡面新增一個 <code>example.org</code> (實際設定可依照您自己註冊的域名去做替換)</p>
<p>example.org:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>example.org.         IN  SOA   dns.example.org. admin.example.org. 2022081321 7200 3600 1209600 3600
</span></span><span style="display:flex;"><span>example.org.         IN  A     10.0.0.1
</span></span><span style="display:flex;"><span>dns.example.org.     IN  A     10.0.0.1
</span></span><span style="display:flex;"><span>mail.example.org.    IN  A     10.0.0.1
</span></span><span style="display:flex;"><span>example.org.         IN  MX    10 mail.example.org
</span></span></code></pre></div><p>設定檔案目錄結構:</p>
<pre tabindex="0"><code>/home/&lt;your_username&gt;/coredns
  ├── Corefile
  └── example.org
</code></pre><p>在完成設定檔後，重新啟動 CoreDNS Docker container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker run -itd --rm --name<span style="color:#f92672">=</span>dns1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v /home/&lt;your_username&gt;/coredns:/cfg <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p 53:53/udp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p 53:53/tcp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  coredns/coredns:1.9.3 -conf /cfg/Corefile
</span></span></code></pre></div><p>然後使用 <code>dig</code> 指令測試您的 DNS Server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>dig @127.0.0.1 A mail.example.org
</span></span></code></pre></div><hr>
<h2 id="壓力測試">壓力測試<a hidden class="anchor" aria-hidden="true" href="#壓力測試">#</a></h2>
<p>安裝完 DNS Server 之後，使用 dnsperf 這項工具來壓力測試一下，在我所租用的 1 cpu、2G ram 的小型主機上可以得到大約 6,000 qps 的處理效能，看起來挺棒的:</p>
<p>測試命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dnsperf -s 127.0.0.1 -d queryfile -l <span style="color:#ae81ff">30</span> -c <span style="color:#ae81ff">20</span> -Q <span style="color:#ae81ff">10000</span>
</span></span></code></pre></div><p>結果:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>DNS Performance Testing Tool
</span></span><span style="display:flex;"><span>Version 2.9.0
</span></span><span style="display:flex;"><span>[Status] Command line: dnsperf -s 127.0.0.1 -d queryfile -l 30 -c 20 -Q 10000
</span></span><span style="display:flex;"><span>[Status] Sending queries (to 127.0.0.1:53)
</span></span><span style="display:flex;"><span>[Status] Started at: Mon Aug 15 12:46:47 2022
</span></span><span style="display:flex;"><span>[Status] Stopping after 30.000000 seconds
</span></span><span style="display:flex;"><span>[Status] Testing complete (time limit)
</span></span><span style="display:flex;"><span>Statistics:
</span></span><span style="display:flex;"><span>Queries sent:         187027
</span></span><span style="display:flex;"><span>  Queries completed:    187027 (100.00%)
</span></span><span style="display:flex;"><span>  Queries lost:         0 (0.00%)
</span></span><span style="display:flex;"><span>Response codes:       NOERROR 187027 (100.00%)
</span></span><span style="display:flex;"><span>  Average packet size:  request 38, response 74
</span></span><span style="display:flex;"><span>  Run time (s):         30.018232
</span></span><span style="display:flex;"><span>  Queries per second:   6230.446883
</span></span><span style="display:flex;"><span>Average Latency (s):  0.015878 (min 0.000180, max 0.217620)
</span></span><span style="display:flex;"><span>  Latency StdDev (s):   0.010163
</span></span></code></pre></div><h2 id="域名代管平台設定">域名代管平台設定<a hidden class="anchor" aria-hidden="true" href="#域名代管平台設定">#</a></h2>
<p>在完成並測試自建 DNS Sever 後，我們就可以將域名代管平台的 DNS 主機設定為我們自建的 DNS Server，以 HiDomain 為例，登入後我們可以點選 “我的網域” 進入網域資訊頁面，然後點選 “更新DNS主機”，將我們自建的 DNS Server 的 IPv4 及 IPv6 位址 (如果有的話) 輸入頁面後按下儲存即可。</p>
<p>以上就完成了一個簡單的 DNS Sever !</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>© 2023. Content on this site is licensed under a CC BY 4.0 license.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
