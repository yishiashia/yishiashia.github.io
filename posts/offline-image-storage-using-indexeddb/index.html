<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用 indexedDB 離線儲存圖片 | yishiashia's Blog</title>
<meta name=keywords content="Front-end,indexedDB,Cache,Offline storage,Progressive Web App,Service Worker"><meta name=description content="學習如何使用 indexedDB 和 Service Worker 實現網頁圖片的離線儲存功能，特別適用於需要處理大量圖片快取的 PWA 應用，如聊天室貼圖功能。包含完整的實作說明和程式碼範例。"><meta name=author content><link rel=canonical href=https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/><link crossorigin=anonymous href=/assets/css/stylesheet.4963a5a8b48ed6d0059c86acc7f948b95b16e935fd9b6b4a8a5a29a5a288346a.css integrity="sha256-SWOlqLSO1tAFnIasx/lIuVsW6TX9m2tKiloppaKINGo=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://yishiashia.github.io/favicon.ico media="(prefers-color-scheme: light)"><link rel=icon href=https://yishiashia.github.io/favicon-dark.ico media="(prefers-color-scheme: dark)"><link rel=icon type=image/png sizes=16x16 href=https://yishiashia.github.io/favicon-16x16.png media="(prefers-color-scheme: light)"><link rel=icon type=image/png sizes=32x32 href=https://yishiashia.github.io/favicon-32x32.png media="(prefers-color-scheme: light)"><link rel=icon type=image/png sizes=16x16 href=https://yishiashia.github.io/favicon-dark-16x16.png media="(prefers-color-scheme: dark)"><link rel=icon type=image/png sizes=32x32 href=https://yishiashia.github.io/favicon-dark-32x32.png media="(prefers-color-scheme: dark)"><link rel=apple-touch-icon href=https://yishiashia.github.io/apple-touch-icon.png><link rel=apple-touch-icon sizes=57x57 href=https://yishiashia.github.io/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://yishiashia.github.io/apple-touch-icon-60x60.png><link rel=mask-icon href=https://yishiashia.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7BRX4099BG"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7BRX4099BG",{anonymize_ip:!1})}</script><meta property="og:title" content="使用 indexedDB 離線儲存圖片"><meta property="og:description" content="學習如何使用 indexedDB 和 Service Worker 實現網頁圖片的離線儲存功能，特別適用於需要處理大量圖片快取的 PWA 應用，如聊天室貼圖功能。包含完整的實作說明和程式碼範例。"><meta property="og:type" content="article"><meta property="og:url" content="https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/"><meta property="og:image" content="https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-07T15:51:22+08:00"><meta property="article:modified_time" content="2022-10-07T15:51:22+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS.jpg"><meta name=twitter:title content="使用 indexedDB 離線儲存圖片"><meta name=twitter:description content="學習如何使用 indexedDB 和 Service Worker 實現網頁圖片的離線儲存功能，特別適用於需要處理大量圖片快取的 PWA 應用，如聊天室貼圖功能。包含完整的實作說明和程式碼範例。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yishiashia.github.io/posts/"},{"@type":"ListItem","position":2,"name":"使用 indexedDB 離線儲存圖片","item":"https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 indexedDB 離線儲存圖片","name":"使用 indexedDB 離線儲存圖片","description":"學習如何使用 indexedDB 和 Service Worker 實現網頁圖片的離線儲存功能，特別適用於需要處理大量圖片快取的 PWA 應用，如聊天室貼圖功能。包含完整的實作說明和程式碼範例。","keywords":["Front-end","indexedDB","Cache","Offline storage","Progressive Web App","Service Worker"],"articleBody":"緣起 由於最近碰到要在負責的網頁式聊天機器人中，新增如同Line聊天室的貼圖功能，可想而知會有大量的貼圖圖片會需要在用戶裝置瀏覽器進行下載，不管是對圖片伺服器或是用戶等待的過程來說都是不小的負擔。\n為了解決這個問題，透過使用了 PWA (Progressive Web App) 技術中常用的離線儲存方案 indexedDB 來快取貼圖圖片，不僅減少用戶端與網站伺服器端的連線流量，也提升的用戶體驗(UX: User Experience) 。\nService Worker Service Worker是一個事件驅動的網站 Worker，根據不同的來源 (origin) 與網址路徑 (path) 進行註冊後，之後再次訪問同一網站後即會在背景執行這個 Service Worker。\nService Worker 無法直接存取 DOM 物件，他負責監聽和處理像是 fetch, notification(推播), sync 還有 Service Worker 註冊、啟動 等相關事件。\n透過處理上述事件，我們可以讓 web 網頁像一般的手機原生 App 一樣可以執行安裝、發送推播、離線瀏覽及連線後同步等等作業。\n離線儲存 常見的 Ｗeb 儲存方案有下面幾種:\nCookie LocalStorage Cache (precache) indexedDB 一般 SPA (Single Page Application) 中比較常用的是 Cookie 跟 LocalStorage 兩種儲存方法，不過在使用上都會有大小的限制（無法儲存較大的網站資源），像是 LocalStorage 的限制依照瀏覽器不同會落在大約 2MB ~ 10MB 左右，超過後就會發出Error。\n而在 PWA 的離線儲存上通常會使用 Cache(precache) 或 indexedDB 來實作，它們的大小通常跟使用者裝置的 disk 空間有關係，以 Chrome 為例，所有網站可以用的共享儲存空間為硬碟可用空間的1/3, 每個網站 App 可以使用共享空間中的 20%。\n舉例:\n如果今天硬碟可用空間有 60GB，那麼其中的 1/3 也就是 20GB 會是共享的儲存空間，那每個網站可以用的大小就是這 20GB 中的 20%，也就是 4GB 左右，所以在儲存一般網頁圖片、影片或是聲音檔等資源應該是相當夠用的。 （ 參考來源: Chrome Developer ）\n解決方案 在基本理解了 Service Worker 的相關知識後，接下來就是透過 Service Ｗorker 攔截圖片下載的 fetch 事件，然後透過 indexedDB 儲存來快取網站圖片，簡單的流程圖如下:\n▲ Service Worker 圖片快取簡略流程圖\n程式碼實作 在網頁載入時，可以透過 navigator.serviceWorker.register 進行 Service Worker 的安裝與註冊:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u003cscript\u003e // Check that service workers are supported if ('serviceWorker' in navigator) { window.addEventListener('load', () =\u003e { navigator.serviceWorker.register('./sw.js') .then(function(registration) { console.log('Registration succeeded.'); }).catch(function(error) { console.log('Registration failed with ' + error); }); }); } \u003c/script\u003e 在 sw.js 中我們就可以定義攔截 fetch 事件 的相關程式邏輯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 self.addEventListener('fetch', async (event) =\u003e { const url = new URL(event.request.url); if ( event.request.destination === 'image' \u0026\u0026 url.pathname.startsWith('/sticker/') ) { // Handle sticker images cache here event.respondWith( cacheMatch(url.pathname) .then(sticker =\u003e { if (sticker !== undefined) { /* 0. 在 indexedDB 找到圖片快取，使用快取中的圖片 */ return new Response(sticker?.blob) } else { /* 1. 找不到快取，丟出錯誤 (後續的錯誤處理會從網站上下載圖片) */ throw new Error( `Sticker not found in DB: ${url.pathname}` ); } }) .catch(err =\u003e { /* 從網站上下載圖片 */ return fetch(event.request) .then(async (httpResponse) =\u003e { const httpResponseToCache = httpResponse.clone(); const imgBlob = await httpResponse.blob(); cachePut({ id: url.pathname, blob: imgBlob }) return httpResponseToCache; }) .catch(err =\u003e { throw err; }) }) ); } }); 詳細實作可以參考 GitHub 範例專案\n結語 透過 Service Worker 結合 indexedDB 的離線儲存方案，我們成功解決了網頁應用中大量圖片快取的需求。這個解決方案不僅能有效減少伺服器負擔，更能顯著提升使用者體驗：\n減少重複的圖片下載請求 降低網路流量消耗 加快圖片載入速度 支援離線瀏覽功能 相較於傳統的 LocalStorage 或 Cookie 儲存方式，indexedDB 提供了更大的儲存空間和更好的效能表現。特別是在開發類似即時通訊這樣需要處理大量圖片資源的 PWA 應用時，這個方案的優勢更為明顯。\n雖然實作過程需要考慮到 Service Worker 的生命週期管理和瀏覽器相容性等問題，但投入這些開發成本是值得的。透過這個方案，我們不僅提供了更好的使用者體驗，也為未來可能的功能擴展（如完整的離線支援）打下了良好的基礎。\n如果您也在開發需要處理大量圖片資源的網頁應用，也許可以考慮採用這個解決方案。不僅可以解決效能問題，更能為您的應用帶來更多的可能性。\n","wordCount":"346","inLanguage":"en","image":"https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS.jpg","datePublished":"2022-10-07T15:51:22+08:00","dateModified":"2022-10-07T15:51:22+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/"},"publisher":{"@type":"Organization","name":"yishiashia's Blog","logo":{"@type":"ImageObject","url":"https://yishiashia.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yishiashia.github.io/ accesskey=h title="  (Alt + H)"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 464 466"><g transform="translate(0.000000,466.000000) scale(0.100000,-0.100000)" fill="currentcolor" stroke="none"><path d="M3e2 4473c-56-24-98-61-123-106-20-38-22-56-21-172 0-1e2 5-148 22-208 12-43 23-81 26-85 3-5 7-20 10-34 6-35 75-233 92-266 8-15 14-36 14-48 0-22 33-108 82-214 16-36 39-90 50-120s26-62 33-70 20-32 28-52c9-20 36-68 61-107 26-39 50-81 56-95 5-14 35-60 67-102s67-89 78-105c11-15 47-50 81-78 33-27 61-56 61-63 2-57 25-264 33-308 6-30 13-70 16-88 2-18 9-42 14-53 6-10 15-45 21-76 6-32 17-71 24-88 7-16 21-50 30-75s25-65 35-90l18-46-77-39c-49-26-94-59-125-93-28-30-63-60-78-68s-39-31-53-52c-14-20-45-62-70-92-69-85-173-304-195-410-7-30-15-68-18-85-4-16-7-95-7-175 1-132 3-152 29-228 15-45 31-82 35-82s27-27 52-60c36-50 56-67 114-94 39-19 88-39 110-45 44-12 886-16 994-5l61 7v98 99h-140-140v406 406l23-14c12-8 40-21 62-28s57-24 79-37c55-35 240-98 257-87 4 2 10 0 13-5 14-21 295-37 406-22 151 20 333 72 393 114 43 30 147 68 148 54 3-62 4-694 1-734l-4-52-151-3-152-3-3-74c-3-69-1-76 24-102l28-29h193c154 0 2e2 3 223 15 61 32 60 21 60 618v544l23 25c151 167 251 308 299 421 16 40 39 91 49 113 49 110 83 290 95 504 7 119 8 120 107 197 31 24 57 50 57 57s27 44 60 82 63 80 66 94c4 14 18 41 33 60 29 38 141 232 141 244 0 4 25 59 55 121 30 63 55 117 55 120s8 24 19 48c10 23 29 76 41 117 13 41 28 84 35 96 7 11 21 49 31 85 10 35 29 93 42 129 48 132 54 162 55 290 1 142-9 190-53 238-75 82-188 102-321 58-91-30-223-88-304-134-91-52-124-74-128-85-3-7-23-19-46-27-22-7-49-22-58-33-10-10-27-23-38-27-11-5-62-40-114-79-84-63-167-150-230-238-12-18-31-33-41-33s-40 18-66 41c-47 38-220 129-247 129-7 0-17 4-23 9-8 8-160 51-194 56-8 1-24 5-35 10s-114 10-230 10c-219 0-293-3-310-14-5-4-23-8-40-10-35-4-231-68-260-85-11-7-39-18-62-24-22-7-63-27-90-45-73-50-78-51-114-9-36 41-2e2 178-279 232-28 19-73 52-101 73-28 20-56 37-63 37-6 0-51 27-1e2 60s-98 62-108 66c-10 3-18 9-18 14 0 4-12 11-27 15-16 3-47 15-70 26-24 10-62 28-86 38-112 51-236 65-307 34zm3934-209c16-22 18-37 12-98-7-88-10-109-18-121-3-6-9-26-12-45-4-19-11-46-16-60s-16-52-26-85-23-69-30-80c-6-11-17-45-24-75s-18-65-26-77-14-29-14-36c0-8-20-55-45-106-25-50-45-96-45-101 0-17-78-176-113-231-19-30-48-81-65-115-17-33-41-73-54-88-66-79-77-90-78-76-2 37-35 238-43 260-3 8-11 33-17 55-7 22-35 90-63 150-41 90-68 130-144 220-51 61-93 116-93 123 0 31 43 92 105 147 36 33 79 72 95 87s46 35 67 43c21 9 49 26 63 39 31 28 123 86 137 86 6 0 33 15 61 33 111 72 172 106 197 107 11 1 52 16 90 35 39 18 72 34 75 34s13-11 24-25zm-3733-14c41-16 77-30 82-30 4 0 51-26 105-57 53-31 124-70 157-87s94-56 135-87c42-31 87-62 1e2-69 44-23 153-120 224-199 18-20 18-21-37-81-31-33-68-77-83-98-15-20-42-53-59-72-18-19-40-57-50-84s-28-65-41-83c-12-19-26-48-30-66-3-18-17-54-29-82-23-50-53-185-57-260l-3-40-35 48c-19 27-47 63-61 80-15 18-30 43-34 57s-31 66-61 116c-30 51-54 95-54 99s-7 21-15 38c-8 18-24 57-35 87-12 30-26 60-32 67-5 7-21 43-35 80-35 95-74 206-77 218-1 6-7 20-14 32s-15 44-19 70c-3 26-9 53-13 58-4 6-22 68-40 138-32 130-34 175-7 218 16 26 33 24 118-11zm2079-416c153-37 231-66 334-125 117-67 180-116 261-204 73-78 185-224 185-241 0-12 34-96 51-127 9-17 41-138 60-227 10-46 14-448 5-457-3-3-18 6-33 21-89 83-124 103-219 126-119 29-198 19-314-38-44-21-132-104-150-140-8-15-19-34-26-42-42-55-57-221-29-317 20-66 31-87 85-156 93-120 287-184 438-144 31 8 28-3-13-43-19-19-35-41-35-49 0-24-180-190-278-257-52-35-112-69-135-75s-46-14-52-18c-17-13-130-51-178-60l-45-8 21 41c12 23 27 47 34 54s13 19 13 27c0 7 7 26 15 41 28 54 37 129 25 191-21 101-127 201-230 219-65 10-123 12-135 4-5-3-21-7-33-8-70-3-188-112-209-191-7-25-13-61-13-79 0-63 38-167 86-237 19-27 18-55-3-55-16 0-108 31-233 78-56 21-167 93-239 155-30 26-58 47-61 47-4 0-23 21-44 47-20 27-59 77-87 112-27 35-48 65-46 67 2 3 17 0 33-6 71-27 213-1 306 57 21 13 42 23 46 23 10 0 102 114 102 125 0 4 8 19 19 33 48 68 53 273 8 354-38 70-43 77-78 116-94 102-188 146-314 146-102 0-207-34-250-79-21-23-87-67-92-62-8 9-9 346-1 405 17 119 39 198 85 3e2 12 29 23 57 23 63 0 18 29 67 67 112 21 25 52 64 68 87 36 51 138 151 185 184 117 80 199 126 263 146 39 13 77 26 82 30 11 8 73 23 77 19 2-1 12 3 23 9 20 10 42 14 165 33 96 14 294 1 410-27zM1531 2386c54-19 116-74 133-117 18-45 20-108 5-162-12-45-79-112-127-128-52-17-130-6-195 26-71 36-87 65-95 163-4 64-2 79 18 115 25 45 28 47 99 89 51 30 105 35 162 14zm1686-12c99-52 123-88 123-182 0-47-25-129-47-154-40-44-180-89-209-66-7 5-16 7-20 6-5-2-33 12-62 30-114 70-136 228-43 320 73 73 173 91 258 46zm-878-739c34-17 41-32 41-93 0-59-17-93-53-105-41-13-75-1-97 36-25 40-25 86-3 126 29 49 65 61 112 36zm-976-234 27-33V884 4e2h-267c-193 0-275 4-292 13-45 22-108 111-120 169-24 112-15 285 17 368 5 14 9 27 9 30s9 23 20 45c12 22 26 58 32 80 18 67 137 226 221 296 41 34 78 66 81 71s34 23 70 42l64 33 55-57c30-31 67-71 83-89z"/></g></svg></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yishiashia.github.io/ title="yishiashia's Blog"><span>Home</span></a></li><li><a href=https://yishiashia.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yishiashia.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yishiashia.github.io/posts/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yishiashia.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yishiashia.github.io/posts/>Posts</a></div><h1 class=post-title>使用 indexedDB 離線儲存圖片</h1><div class=post-description>學習如何使用 indexedDB 和 Service Worker 實現網頁圖片的離線儲存功能，特別適用於需要處理大量圖片快取的 PWA 應用，如聊天室貼圖功能。包含完整的實作說明和程式碼範例。</div><div class=post-meta><span title='2022-10-07 15:51:22 +0800 +0800'>October 7, 2022</span>&nbsp;·&nbsp;2 min</div></header><figure class=entry-cover><img srcset="https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS_hudc810591234e40dcfeb7ce8908cb8d51_135714_360x0_resize_q75_box.jpg 360w ,https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS_hudc810591234e40dcfeb7ce8908cb8d51_135714_480x0_resize_q75_box.jpg 480w ,https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS_hudc810591234e40dcfeb7ce8908cb8d51_135714_720x0_resize_q75_box.jpg 720w ,https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS_hudc810591234e40dcfeb7ce8908cb8d51_135714_1080x0_resize_q75_box.jpg 1080w ,https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS.jpg 1400w" sizes="(min-width: 768px) 720px, 100vw" src=https://yishiashia.github.io/posts/offline-image-storage-using-indexeddb/0_SE5YTSIGxPUrOgGS.jpg alt="Photo by [Scott Graham](https://unsplash.com/@homajob) on [Unsplash](https://unsplash.com/)" width=1400 height=934><p>Photo by <a href=https://unsplash.com/@homajob target=_blank rel="external nofollow noreferrer noopener">Scott Graham</a> on <a href=https://unsplash.com/ target=_blank rel="external nofollow noreferrer noopener">Unsplash</a></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%b7%a3%e8%b5%b7 aria-label=緣起>緣起</a></li><li><a href=#service-worker aria-label="Service Worker">Service Worker</a></li><li><a href=#%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98 aria-label=離線儲存>離線儲存</a></li><li><a href=#%e8%a7%a3%e6%b1%ba%e6%96%b9%e6%a1%88 aria-label=解決方案>解決方案</a></li><li><a href=#%e7%a8%8b%e5%bc%8f%e7%a2%bc%e5%af%a6%e4%bd%9c aria-label=程式碼實作>程式碼實作</a></li><li><a href=#%e7%b5%90%e8%aa%9e aria-label=結語>結語</a></li></ul></div></details></div><div class=post-content><h2 id=緣起>緣起<a hidden class=anchor aria-hidden=true href=#緣起>#</a></h2><p>由於最近碰到要在負責的網頁式聊天機器人中，新增如同Line聊天室的貼圖功能，可想而知會有大量的貼圖圖片會需要在用戶裝置瀏覽器進行下載，不管是對圖片伺服器或是用戶等待的過程來說都是不小的負擔。</p><p>為了解決這個問題，透過使用了 PWA (Progressive Web App) 技術中常用的離線儲存方案 indexedDB 來快取貼圖圖片，不僅減少用戶端與網站伺服器端的連線流量，也提升的用戶體驗(UX: User Experience) 。</p><h2 id=service-worker>Service Worker<a hidden class=anchor aria-hidden=true href=#service-worker>#</a></h2><p>Service Worker是一個事件驅動的網站 Worker，根據不同的來源 (origin) 與網址路徑 (path) 進行註冊後，之後再次訪問同一網站後即會在背景執行這個 Service Worker。</p><p>Service Worker 無法直接存取 DOM 物件，他負責監聽和處理像是 <em>fetch</em>, <em>notification(推播)</em>, <em>sync</em> 還有 <em>Service Worker 註冊</em>、<em>啟動</em> 等相關事件。</p><p>透過處理上述事件，我們可以讓 web 網頁像一般的手機原生 App 一樣可以執行安裝、發送推播、離線瀏覽及連線後同步等等作業。</p><h2 id=離線儲存>離線儲存<a hidden class=anchor aria-hidden=true href=#離線儲存>#</a></h2><p>常見的 Ｗeb 儲存方案有下面幾種:</p><ol><li>Cookie</li><li>LocalStorage</li><li>Cache (precache)</li><li>indexedDB</li></ol><p>一般 SPA (Single Page Application) 中比較常用的是 Cookie 跟 LocalStorage 兩種儲存方法，不過在使用上都會有大小的限制（無法儲存較大的網站資源），像是 LocalStorage 的限制依照瀏覽器不同會落在大約 2MB ~ 10MB 左右，超過後就會發出Error。</p><p>而在 PWA 的離線儲存上通常會使用 Cache(precache) 或 indexedDB 來實作，它們的大小通常跟使用者裝置的 disk 空間有關係，以 Chrome 為例，所有網站可以用的共享儲存空間為硬碟可用空間的1/3, 每個網站 App 可以使用共享空間中的 20%。</p><blockquote><p>舉例:</p><p>如果今天硬碟可用空間有 60GB，那麼其中的 1/3 也就是 20GB 會是共享的儲存空間，那每個網站可以用的大小就是這 20GB 中的 20%，也就是 4GB 左右，所以在儲存一般網頁圖片、影片或是聲音檔等資源應該是相當夠用的。 （ 參考來源: <a href=https://developer.chrome.com/docs/apps/offline_storage/#temporary target=_blank rel="external nofollow noreferrer noopener">Chrome Developer</a> ）</p></blockquote><h2 id=解決方案>解決方案<a hidden class=anchor aria-hidden=true href=#解決方案>#</a></h2><p>在基本理解了 Service Worker 的相關知識後，接下來就是透過 Service Ｗorker 攔截圖片下載的 fetch 事件，然後透過 indexedDB 儲存來快取網站圖片，簡單的流程圖如下:</p><p><img loading=lazy src=1_nEaZdLHz9L-1rEuOMJYFFQ.webp alt="flow chart">
<em>▲ Service Worker 圖片快取簡略流程圖</em></p><h2 id=程式碼實作>程式碼實作<a hidden class=anchor aria-hidden=true href=#程式碼實作>#</a></h2><p>在網頁載入時，可以透過 <code>navigator.serviceWorker.register</code> 進行 Service Worker 的安裝與註冊:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check that service workers are supported
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#39;serviceWorker&#39;</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>navigator</span>) {
</span></span><span style=display:flex><span>    window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;load&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>serviceWorker</span>.<span style=color:#a6e22e>register</span>(<span style=color:#e6db74>&#39;./sw.js&#39;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>registration</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Registration succeeded.&#39;</span>);
</span></span><span style=display:flex><span>        }).<span style=color:#66d9ef>catch</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Registration failed with &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></td></tr></table></div></div><p>在 <em>sw.js</em> 中我們就可以定義攔截 <em>fetch</em> 事件 的相關程式邏輯</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;fetch&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URL</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>url</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>destination</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;image&#39;</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;/sticker/&#39;</span>)
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Handle sticker images cache here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>respondWith</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cacheMatch</span>(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>sticker</span> =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>sticker</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>/* 0. 在 indexedDB 找到圖片快取，使用快取中的圖片 */</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Response</span>(<span style=color:#a6e22e>sticker</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>blob</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>/* 1. 找不到快取，丟出錯誤
</span></span></span><span style=display:flex><span><span style=color:#75715e>                (後續的錯誤處理會從網站上下載圖片) */</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>`Sticker not found in DB: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>          );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>      .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* 從網站上下載圖片 */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>request</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>httpResponse</span>) =&gt; {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>httpResponseToCache</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>httpResponse</span>.<span style=color:#a6e22e>clone</span>();
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imgBlob</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>httpResponse</span>.<span style=color:#a6e22e>blob</span>();
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>cachePut</span>({
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>pathname</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>blob</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>imgBlob</span>
</span></span><span style=display:flex><span>              })
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>httpResponseToCache</span>;
</span></span><span style=display:flex><span>          })
</span></span><span style=display:flex><span>          .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>err</span>;
</span></span><span style=display:flex><span>          })
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><p>詳細實作可以參考 <a href=https://github.com/yishiashia/indexeddb-image-cache target=_blank rel="external nofollow noreferrer noopener">GitHub 範例專案</a></p><hr><h2 id=結語>結語<a hidden class=anchor aria-hidden=true href=#結語>#</a></h2><p>透過 Service Worker 結合 indexedDB 的離線儲存方案，我們成功解決了網頁應用中大量圖片快取的需求。這個解決方案不僅能有效減少伺服器負擔，更能顯著提升使用者體驗：</p><ul><li>減少重複的圖片下載請求</li><li>降低網路流量消耗</li><li>加快圖片載入速度</li><li>支援離線瀏覽功能</li></ul><p>相較於傳統的 LocalStorage 或 Cookie 儲存方式，indexedDB 提供了更大的儲存空間和更好的效能表現。特別是在開發類似即時通訊這樣需要處理大量圖片資源的 PWA 應用時，這個方案的優勢更為明顯。</p><p>雖然實作過程需要考慮到 Service Worker 的生命週期管理和瀏覽器相容性等問題，但投入這些開發成本是值得的。透過這個方案，我們不僅提供了更好的使用者體驗，也為未來可能的功能擴展（如完整的離線支援）打下了良好的基礎。</p><p>如果您也在開發需要處理大量圖片資源的網頁應用，也許可以考慮採用這個解決方案。不僅可以解決效能問題，更能為您的應用帶來更多的可能性。</p></div><footer class=post-footer><div class=related><h3 class=see-also>您可能有興趣</h3><ul><li><a href=/posts/chrome-devtool-mock-api/>[前端開發] 使用 Chrome 開發者工具模擬後端 API 回應</a></li><li><a href=/posts/webcomponent-introduction-3/>Web Components 介紹與實作說明 (3) | 模組化開源與 CDN</a></li><li><a href=/posts/webcomponent-introduction-2/>Web Components 介紹與實作說明 (2) | 實作一個 Tooltip 元件</a></li><li><a href=/posts/webcomponent-introduction-1/>Web Components 介紹與實作說明 (1)</a></li><li><a href=/posts/dark-mode-and-css-color-scheme/>網頁深色模式與 CSS 相關屬性</a></li></ul></div><ul class=post-tags><li><a href=https://yishiashia.github.io/tags/front-end/>Front-end</a></li><li><a href=https://yishiashia.github.io/tags/indexeddb/>indexedDB</a></li><li><a href=https://yishiashia.github.io/tags/cache/>Cache</a></li><li><a href=https://yishiashia.github.io/tags/offline-storage/>Offline storage</a></li><li><a href=https://yishiashia.github.io/tags/progressive-web-app/>Progressive Web App</a></li><li><a href=https://yishiashia.github.io/tags/service-worker/>Service Worker</a></li></ul><nav class=paginav><a class=prev href=https://yishiashia.github.io/posts/introduction-to-basic-cryptography/><span class=title>« Next</span><br><span>簡易密碼學介紹</span>
</a><a class=next href=https://yishiashia.github.io/posts/self-hosted-dns-with-coredns/><span class=title>Prev »</span><br><span>使用 CoreDNS 自建 DNS Server</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on x" href="https://x.com/intent/tweet/?text=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87&amp;url=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f&amp;hashtags=Front-end%2cindexedDB%2cCache%2cOfflinestorage%2cProgressiveWebApp%2cServiceWorker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f&amp;title=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87&amp;summary=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87&amp;source=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f&title=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on whatsapp" href="https://api.whatsapp.com/send?text=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87%20-%20https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on telegram" href="https://telegram.me/share/url?text=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87&amp;url=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 使用 indexedDB 離線儲存圖片 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e4%bd%bf%e7%94%a8%20indexedDB%20%e9%9b%a2%e7%b7%9a%e5%84%b2%e5%ad%98%e5%9c%96%e7%89%87&u=https%3a%2f%2fyishiashia.github.io%2fposts%2foffline-image-storage-using-indexeddb%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://yishiashia-blog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>Copyright © 2023 <a href=mailto:yishiashia@gmail.com target=_blank rel="external nofollow noreferrer noopener">yishiashia@gmail.com</a>. All rights reserved.</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>