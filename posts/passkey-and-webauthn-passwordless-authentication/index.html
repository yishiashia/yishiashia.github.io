<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 | yishiashia&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Google、Apple、微軟及數百間科技公司或服務商在今年 (2022) 不約而同的表態支持 FIDO 聯盟與 W3C 所主推的通用無密碼登入標準 (common passwordless sign-in standard)，希望能透過例如指紋、Face ID等認證手段替代原本的密碼登入機制，提供用戶在網頁登入時一個更安全、防網路釣魚、即時交易驗證的登入方式。
Google 在今年10月上旬宣布在 Android 及 Chrome 導入 Passkey 無密碼認證機制，而 Apple 也將在 iOS 16 和 macOS Ventura 引入 Passkey ，透過掃描 QR Code 加上藍芽或其他裝置通訊技術，讓你可以透過手機的 Touch ID 或 Face ID 就可以登入你所有的電腦、平板等裝置。
下面我們會先說明需要使用密碼跟無密碼認證使用的場景，再深入介紹實務上使用 FIDO2 進行註冊與認證 (含範例程式)，最後再總結 FIDO2 / WebAuthn 與 Passkey 的關係 。
Photo by regularguy.eth on Unsplash
通常需要用到 ”密碼” 或 ”認證” 的場合，像是在電商網站買東西、下訂單最後要結帳的時候會請你輸入帳號、密碼做登入(不登入的話也可能會要求你透過手機簡訊驗證碼做實名制驗證)，可以用以確保您在真實世界的身分。
在資訊安全的領域中，不管是帳號密碼或是手機簡訊驗證碼的驗證，都是屬於 挑戰回應(Challenge/Response) 的方法。
挑戰回應 的方法具體來說，是指由正在溝通的兩方其中之一發起一個 挑戰 (Challenge)，而另一方提供一個正確可被驗證的合法答案 (Response)。
最常見的使用情境就是使用密碼驗證，比方說在電商網站購物前送出訂單之前請買家在網頁上再輸入一次密碼，如果密碼正確 (Valid response) ，則可以確認是由本人進行的操作。">
<meta name="author" content="">
<link rel="canonical" href="https://yishiashia.github.io/posts/passkey-and-webauthn-passwordless-authentication/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3a6b9c9a973092e29785badda15158e8e2635ec041880295a449aef883a824d2.css" integrity="sha256-OmucmpcwkuKXhbrdoVFY6OJjXsBBiAKVpEmu&#43;IOoJNI=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://yishiashia.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://yishiashia.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://yishiashia.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://yishiashia.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://yishiashia.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="使用 WebAuthn 實作無密碼驗證與 Passkey 介紹" />
<meta property="og:description" content="Google、Apple、微軟及數百間科技公司或服務商在今年 (2022) 不約而同的表態支持 FIDO 聯盟與 W3C 所主推的通用無密碼登入標準 (common passwordless sign-in standard)，希望能透過例如指紋、Face ID等認證手段替代原本的密碼登入機制，提供用戶在網頁登入時一個更安全、防網路釣魚、即時交易驗證的登入方式。
Google 在今年10月上旬宣布在 Android 及 Chrome 導入 Passkey 無密碼認證機制，而 Apple 也將在 iOS 16 和 macOS Ventura 引入 Passkey ，透過掃描 QR Code 加上藍芽或其他裝置通訊技術，讓你可以透過手機的 Touch ID 或 Face ID 就可以登入你所有的電腦、平板等裝置。
下面我們會先說明需要使用密碼跟無密碼認證使用的場景，再深入介紹實務上使用 FIDO2 進行註冊與認證 (含範例程式)，最後再總結 FIDO2 / WebAuthn 與 Passkey 的關係 。
Photo by regularguy.eth on Unsplash
通常需要用到 ”密碼” 或 ”認證” 的場合，像是在電商網站買東西、下訂單最後要結帳的時候會請你輸入帳號、密碼做登入(不登入的話也可能會要求你透過手機簡訊驗證碼做實名制驗證)，可以用以確保您在真實世界的身分。
在資訊安全的領域中，不管是帳號密碼或是手機簡訊驗證碼的驗證，都是屬於 挑戰回應(Challenge/Response) 的方法。
挑戰回應 的方法具體來說，是指由正在溝通的兩方其中之一發起一個 挑戰 (Challenge)，而另一方提供一個正確可被驗證的合法答案 (Response)。
最常見的使用情境就是使用密碼驗證，比方說在電商網站購物前送出訂單之前請買家在網頁上再輸入一次密碼，如果密碼正確 (Valid response) ，則可以確認是由本人進行的操作。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yishiashia.github.io/posts/passkey-and-webauthn-passwordless-authentication/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-15T16:22:57+08:00" />
<meta property="article:modified_time" content="2022-11-15T16:22:57+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 WebAuthn 實作無密碼驗證與 Passkey 介紹"/>
<meta name="twitter:description" content="Google、Apple、微軟及數百間科技公司或服務商在今年 (2022) 不約而同的表態支持 FIDO 聯盟與 W3C 所主推的通用無密碼登入標準 (common passwordless sign-in standard)，希望能透過例如指紋、Face ID等認證手段替代原本的密碼登入機制，提供用戶在網頁登入時一個更安全、防網路釣魚、即時交易驗證的登入方式。
Google 在今年10月上旬宣布在 Android 及 Chrome 導入 Passkey 無密碼認證機制，而 Apple 也將在 iOS 16 和 macOS Ventura 引入 Passkey ，透過掃描 QR Code 加上藍芽或其他裝置通訊技術，讓你可以透過手機的 Touch ID 或 Face ID 就可以登入你所有的電腦、平板等裝置。
下面我們會先說明需要使用密碼跟無密碼認證使用的場景，再深入介紹實務上使用 FIDO2 進行註冊與認證 (含範例程式)，最後再總結 FIDO2 / WebAuthn 與 Passkey 的關係 。
Photo by regularguy.eth on Unsplash
通常需要用到 ”密碼” 或 ”認證” 的場合，像是在電商網站買東西、下訂單最後要結帳的時候會請你輸入帳號、密碼做登入(不登入的話也可能會要求你透過手機簡訊驗證碼做實名制驗證)，可以用以確保您在真實世界的身分。
在資訊安全的領域中，不管是帳號密碼或是手機簡訊驗證碼的驗證，都是屬於 挑戰回應(Challenge/Response) 的方法。
挑戰回應 的方法具體來說，是指由正在溝通的兩方其中之一發起一個 挑戰 (Challenge)，而另一方提供一個正確可被驗證的合法答案 (Response)。
最常見的使用情境就是使用密碼驗證，比方說在電商網站購物前送出訂單之前請買家在網頁上再輸入一次密碼，如果密碼正確 (Valid response) ，則可以確認是由本人進行的操作。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://yishiashia.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "使用 WebAuthn 實作無密碼驗證與 Passkey 介紹",
      "item": "https://yishiashia.github.io/posts/passkey-and-webauthn-passwordless-authentication/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "使用 WebAuthn 實作無密碼驗證與 Passkey 介紹",
  "name": "使用 WebAuthn 實作無密碼驗證與 Passkey 介紹",
  "description": "Google、Apple、微軟及數百間科技公司或服務商在今年 (2022) 不約而同的表態支持 FIDO 聯盟與 W3C 所主推的通用無密碼登入標準 (common passwordless sign-in standard)，希望能透過例如指紋、Face ID等認證手段替代原本的密碼登入機制，提供用戶在網頁登入時一個更安全、防網路釣魚、即時交易驗證的登入方式。\nGoogle 在今年10月上旬宣布在 Android 及 Chrome 導入 Passkey 無密碼認證機制，而 Apple 也將在 iOS 16 和 macOS Ventura 引入 Passkey ，透過掃描 QR Code 加上藍芽或其他裝置通訊技術，讓你可以透過手機的 Touch ID 或 Face ID 就可以登入你所有的電腦、平板等裝置。\n下面我們會先說明需要使用密碼跟無密碼認證使用的場景，再深入介紹實務上使用 FIDO2 進行註冊與認證 (含範例程式)，最後再總結 FIDO2 / WebAuthn 與 Passkey 的關係 。\nPhoto by regularguy.eth on Unsplash\n通常需要用到 ”密碼” 或 ”認證” 的場合，像是在電商網站買東西、下訂單最後要結帳的時候會請你輸入帳號、密碼做登入(不登入的話也可能會要求你透過手機簡訊驗證碼做實名制驗證)，可以用以確保您在真實世界的身分。\n在資訊安全的領域中，不管是帳號密碼或是手機簡訊驗證碼的驗證，都是屬於 挑戰回應(Challenge/Response) 的方法。\n挑戰回應 的方法具體來說，是指由正在溝通的兩方其中之一發起一個 挑戰 (Challenge)，而另一方提供一個正確可被驗證的合法答案 (Response)。\n最常見的使用情境就是使用密碼驗證，比方說在電商網站購物前送出訂單之前請買家在網頁上再輸入一次密碼，如果密碼正確 (Valid response) ，則可以確認是由本人進行的操作。",
  "keywords": [
    
  ],
  "articleBody": "Google、Apple、微軟及數百間科技公司或服務商在今年 (2022) 不約而同的表態支持 FIDO 聯盟與 W3C 所主推的通用無密碼登入標準 (common passwordless sign-in standard)，希望能透過例如指紋、Face ID等認證手段替代原本的密碼登入機制，提供用戶在網頁登入時一個更安全、防網路釣魚、即時交易驗證的登入方式。\nGoogle 在今年10月上旬宣布在 Android 及 Chrome 導入 Passkey 無密碼認證機制，而 Apple 也將在 iOS 16 和 macOS Ventura 引入 Passkey ，透過掃描 QR Code 加上藍芽或其他裝置通訊技術，讓你可以透過手機的 Touch ID 或 Face ID 就可以登入你所有的電腦、平板等裝置。\n下面我們會先說明需要使用密碼跟無密碼認證使用的場景，再深入介紹實務上使用 FIDO2 進行註冊與認證 (含範例程式)，最後再總結 FIDO2 / WebAuthn 與 Passkey 的關係 。\nPhoto by regularguy.eth on Unsplash\n通常需要用到 ”密碼” 或 ”認證” 的場合，像是在電商網站買東西、下訂單最後要結帳的時候會請你輸入帳號、密碼做登入(不登入的話也可能會要求你透過手機簡訊驗證碼做實名制驗證)，可以用以確保您在真實世界的身分。\n在資訊安全的領域中，不管是帳號密碼或是手機簡訊驗證碼的驗證，都是屬於 挑戰回應(Challenge/Response) 的方法。\n挑戰回應 的方法具體來說，是指由正在溝通的兩方其中之一發起一個 挑戰 (Challenge)，而另一方提供一個正確可被驗證的合法答案 (Response)。\n最常見的使用情境就是使用密碼驗證，比方說在電商網站購物前送出訂單之前請買家在網頁上再輸入一次密碼，如果密碼正確 (Valid response) ，則可以確認是由本人進行的操作。\n但使用密碼作為驗證手段所衍生出的資安議題非常多，比方說網站管理者可能為了安全性而要求用戶使用的密碼複雜度必須足夠，但過於複雜的密碼常常會讓使用者記不起來，所以就寫在便條紙、記在手機備忘錄或存在檔案中，造成密碼洩漏的問題，而這也是 Apple, Google 及 Microsoft 三大廠商都主推無密碼認證的原因之一。\n而在Web端要達到去密碼化，主要使用的解決方案還是透過 W3C 與 FIDO 聯盟所提出的 Web Authentication API (aka WebAuthn) 規範，而 WebAuthn 主要是使用密碼學中的非對稱性演算法與公私鑰取代密碼來進行訊息保密與驗證來完成 Challenge / Response 的機制。\n使用者在 APP 或瀏覽器端會產生一組公/私鑰，私鑰會保留在使用的裝置上(如瀏覽器或手機裝置的 keychain 中)，而公鑰會透過 Attestation 的流程註冊到網站伺服器端，網站伺服器收到後會儲存下來，後續在跟用戶端進行訊息傳送時就會使用這對公/私鑰來進行訊息保密與驗證。\n註: 想了解關於非對稱式加密演算法或公/私鑰的概念，可以參考:\n簡易密碼學介紹\nPasskey 由三大巨頭主推的 Passkey 讓您可以透過您現在解鎖手機的方法，像是 Touch ID、Face ID 等方式來登入網站或 App。\n您只需要使用您的生物特徵或PIN碼來啟動裝置上的Authenticator(認證器)，就可以透過安全的密碼簽章來跟網站伺服器溝通，取代原本使用的密碼，就像把家裡的大門從傳統鑰匙的鎖頭換成可以用指紋辨識的電子鎖一樣，不用再帶著鑰匙(密碼)出門了。\n而 Passkey 主要是奠基於 FIDO聯盟 與 W3C 所主推的 FIDO2 與 WebAuthn 認證流程，基於這套認證機制，加上了像是掃描 QR Code 等方式，讓您可以使用儲存在手機上的私鑰 (或 credential) ，跨平台登入電腦PC上的網頁，這種跨平台的便利方式相信可以提升原本FIDO2無密碼驗證的使用者體驗，讓無密碼驗證越來越普及。\n接下來，就讓我們來介紹一下 FIDO2 與 WebAuthn 吧。\nFIDO2 與 WebAuthn FIDO2是一個去密碼化的認證流程，可以透過裝置上的Authenticator (例如: Touch ID、Face ID 或 USB金鑰)授權後，再經由瀏覽器中的 WebAuthn API 來使用裝置中儲存的私鑰來與網站伺服器端進行註冊或訊息驗證。\nFIDO2 / WebAuthn 認證流程\n角色與說明 Authenticator: 基於密碼學的身分驗證器，像是智慧型手機或USB金鑰等，依照金鑰儲存特性可以區分為 platform 與 cross-platform 兩種，platform 身分驗證器是內嵌在裝置內，比如像是智慧型手機的 Touch ID 或 Face ID 等，而 cross-platform 的身分驗證器則是可以跨裝置使用的，比如像是 USB 金鑰。 WebAuthn API: 在支援 WebAuthn 的瀏覽器上，我們可以透過 JavaScript 來呼叫 WebAuthn API，WebAuthn API 在收到 來自後端伺服器的挑戰 (challenge) 後，就會透過 CTAP (Client to Authenticator Protocol) 來請求身分驗證器簽署 challenge 並產生合法的回應 (signed assertion) ，後端伺服器收到這個回應後，透過先前註冊的公鑰進行解密與驗證，如果驗證成功即可允許用戶登入或進行操作。 User: 金鑰的擁有者，在網站透過 WebAuthn API 存取金鑰時，會需要擁有者進行授權的動作，在上面的流程圖中是透過用戶輸入 PIN 碼來取用身分驗證器中的金鑰進行簽署，而其他像是 Touch ID 或 Face ID 也會需要用戶在進行挑戰/回應時刷一下指紋或臉，都是在請求使用者進行授權取用身分驗證器。 Relying party: 用戶註冊與驗證的後端網站伺服器，用戶註冊時提供的公鑰會儲存在這個伺服器中。 Attestation (Register) Attestation 在 WebAuthn 的流程中代表的是 Authenticator 金鑰產生並註冊到後端 Relying party 的過程，簡易的流程如下:\n後端 Relying party (網站伺服器) 產生一組隨機、一次性的 challenge bytes (32 bytes) ，傳送到前端瀏覽器的網頁中。 前端的 JavaScript 程式收到 challenge 後，透過 WebAuthn API 存取裝置中或跨裝置的 Authenticator 產生一組 credential (內含一對公/私鑰)，並得到一個 Attestation 物件資料，Attestation 物件中包含簽署 challenge 後的 Assertion 資料與公鑰 (public key) 。 前端 JS 程式將 Attestation 資料回傳給後端伺服器 (Relying party) ，伺服器收到後使用公鑰驗證簽署後的 Assertion 資料，確認 challenge 一致後，即可將用戶的公鑰儲存下來，並與用戶的帳號 ID (依網站規劃，通常可以使用手機或email做用戶實名制帳號 ID) 做連結。 範例程式如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 async function doRegister() { const publicKeyCredential = await navigator.credentials.create({ publicKey: { rp: { name: \"example-org\" }, user: { // 這邊放使用者相關的資料 (後續會註冊在 authenticator 中，關聯到對應的一組 credential) id: \"edd1f115-6198-11ed-a902-0242ac1d0103\", name: \"bob@example.org\", displayName: \"Bob\" }, pubKeyCredParams: [ { type: \"public-key\", alg: -7 } ], authenticatorSelection: { authenticatorAttachment: \"platform\" }, attestation: \"direct\", timeout: 60000, challenge: new Uint8Array([ // 註: 這邊需要從後端伺服器產生一組本次登入使用的一次性 challenge bytes // 以防止釣魚攻擊，不可以寫死 0xDC, 0x69, 0xDD, 0xBA, 0xB0, 0xBF, 0x3A, 0x9B, 0xDB, 0x89, 0x9F, 0x58, 0x84, 0x2D, 0x6F, 0x29, 0xE1, 0x20, 0x30, 0x20, 0xB6, 0x4E, 0xFF, 0x14, 0x74, 0x95, 0x4B, 0x56, 0x28, 0xEB, 0x2F, 0xFD ]).buffer } }); console.log(\"透過CTAP取得簽署後的assertion資料為: \", publicKeyCredential); } // 當使用者點下註冊按鈕時，執行 doRegister 函式 window.onload = function() { const button = document.getElementById('register-btn'); button.addEventListener('click', doRegister); } 說明:\n透過使用 Credential Management API，我們可以存取裝置上或外部跨裝置的 Authenticator 來產生一組金鑰 credential。\n在上面的範例中，我們呼叫了 navigator.credentials.create () 這個函式，並注入了金鑰產製的相關參數，包含 rp、user、pubKeyCredParams、authenticatorSelection、challenge 與 timeout。\nrp 代表 Relying party ，也就是網站或服務的資訊。 user 是使用者相關的資訊，包含 id、name 與 displayName，後續在認證過程中會顯示在選單中，讓使用者可以選擇要用哪個身份登入網站。 pubKeyCredParams 設定 rp 支援的非對稱式金鑰加密演算法列表，裝置authenticator 會在此列表中找尋適合的演算法並產生對應的金鑰。 authenticatorSelection.authenticatorAttachment 可以指令認證器的形式，您可以選擇 platform / cross-platform，如果使用 platform authenticator 就可以啟用像是 Touch ID 或 Face ID 等裝置內建的認證器，而如果選擇 cross-platform 的話，手機或電腦就會嘗試去尋找是否已經有外接的硬體認證器 (像是 USB硬體認證器)。 challenge 是由後端伺服器 (Relying party) 所產生的一次性的驗證 token (長度是32 bytes) ，在驗證發生的當下由 Relying party 隨機產生並暫存下來，等後續前端透過認證器簽署完成回傳給 RP，RP端可以使用公鑰進行驗證 (避免 phishing) 。 Assertion (認證) 完成註冊程序以後，在同一個裝置瀏覽這個網站時，即可透過儲存在裝置中的進行登入或交易驗證，簡易的流程如下:\n後端收到使用者需要進行驗證的交易請求，產生一組跟本次交易有關的一次性隨機的 challenge bytes (32 bytes) ，並傳送到前端網頁中。 前端 JavaScript 程式收到 challenge 後，透過 WebAuthn API 存取裝置中或跨裝置的 Authenticator 中的 credential 私鑰對 challenge bytes 進行簽署並產生 assertion 資料物件。 將 assertion 物件送到後端伺服器 (Relying party) ，後端伺服器透過儲存的公鑰對 assertion 進行驗證，如驗證無誤即可批准本次交易或登入動作。 範例程式如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 async function doLogin() { const publicKeyCredential = await navigator.credentials.get({ publicKey: { rp: { name: \"example-org\" }, timeout: 60000, challenge: new Uint8Array([ // 註: 這邊需要從後端伺服器產生一組本次登入使用的一次性 challenge bytes // 以防止釣魚攻擊，不可以寫死 0xDC, 0x69, 0xDD, 0xBA, 0xB0, 0xBF, 0x3A, 0x9B, 0xDB, 0x89, 0x9F, 0x58, 0x84, 0x2D, 0x6F, 0x29, 0xE1, 0x20, 0x30, 0x20, 0xB6, 0x4E, 0xFF, 0x14, 0x74, 0x95, 0x4B, 0x56, 0x28, 0xEB, 0x2F, 0xFD ]).buffer, allowCredentials: [] // 如果有先前登入的session資料，可以將使用者相關的金鑰列在這邊， // 裝置在認證時就不會跳出太多金鑰讓使用者眼花撩亂 } }); console.log(\"透過CTAP取得簽署後的assertion資料為: \", publicKeyCredential); } // 當使用者點下登入按鈕時，執行 doLogin 函式 window.onload = function() { const button = document.getElementById('login-btn'); button.addEventListener('click', doLogin); } 說明:\n在認證的流程中同樣使用 Credential Management API 來存取裝置上或外部跨裝置的 Authenticator 並簽署 RP 所給的 challenge 參數。\n在上面的範例中，我們呼叫了 navigator.credentials.get() 這個函式，並注入了相關參數，包含 rp、challenge 與 allowCredentials 等。\nallowCredentials 是允許使用的 credentials 列表，通常在用戶先前已經登入過但登入 session 已經逾期時，讓用戶再次登入使用，透過這個列表可以限縮用戶可以使用的金鑰，讓用戶在認證時可以簡單的選到想要的登入帳號或身分。 結語: 從 FIDO2 / WebAuthn 到 Passkey 前面提到了 WebAuthn 的註冊與驗證流程，可以發現在現行的 FIDO2 / WebAuthn 的使用上，必須在每個裝置上都註冊一組金鑰 (platform credential) ，但如果使用的是公用電腦或裝置，使用者不會想在上面註冊一組 platform credential 。\n這時就得使用跨平台的認證器裝置，像是 USB金鑰 或是其他硬體認證器裝置，除了攜帶不便，也需要這個硬體認證器裝置相容於每台裝置，所以 FIDO2/WebAuthn 在使用上一直沒有很普及。\n為了解決使用者體驗不佳的問題並推廣無密碼驗證，包含 Google、Apple及微軟還有其他上百家企業都積極投入 Passkey 這項新的認證機制，而 Passkey 主要就是希望透過瀏覽器、作業系統之間的溝通達到跨平台存取 platform credential，解決目前 FIDO2 / WebAuthn 在實務上使用的痛點。\n相信在不久的未來，我們就可以真正拋棄密碼認證方式，使用更安全方便的無密碼認證方法。\n",
  "wordCount" : "700",
  "inLanguage": "en",
  "datePublished": "2022-11-15T16:22:57+08:00",
  "dateModified": "2022-11-15T16:22:57+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://yishiashia.github.io/posts/passkey-and-webauthn-passwordless-authentication/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "yishiashia's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://yishiashia.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://yishiashia.github.io/" accesskey="h" title="  (Alt + H)">
                    <svg version='1.0' xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 464.000000 466.000000' preserveAspectRatio='xMidYMid meet'><g transform='translate(0.000000,466.000000) scale(0.100000,-0.100000)' fill='currentColor' stroke='none'><path d='M300 4473 c-56 -24 -98 -61 -123 -106 -20 -38 -22 -56 -21 -172 0 -100 5 -148 22 -208 12 -43 23 -81 26 -85 3 -5 7 -20 10 -34 6 -35 75 -233 92 -266 8 -15 14 -36 14 -48 0 -22 33 -108 82 -214 16 -36 39 -90 50 -120 11 -30 26 -62 33 -70 7 -8 20 -32 28 -52 9 -20 36 -68 61 -107 26 -39 50 -81 56 -95 5 -14 35 -60 67 -102 32 -42 67 -89 78 -105 11 -15 47 -50 81 -78 33 -27 61 -56 61 -63 2 -57 25 -264 33 -308 6 -30 13 -70 16 -88 2 -18 9 -42 14 -53 6 -10 15 -45 21 -76 6 -32 17 -71 24 -88 7 -16 21 -50 30 -75 9 -25 25 -65 35 -90 l18 -46 -77 -39 c-49 -26 -94 -59 -125 -93 -28 -30 -63 -60 -78 -68 -15 -8 -39 -31 -53 -52 -14 -20 -45 -62 -70 -92 -69 -85 -173 -304 -195 -410 -7 -30 -15 -68 -18 -85 -4 -16 -7 -95 -7 -175 1 -132 3 -152 29 -228 15 -45 31 -82 35 -82 4 0 27 -27 52 -60 36 -50 56 -67 114 -94 39 -19 88 -39 110 -45 44 -12 886 -16 994 -5 l61 7 0 98 0 99 -140 0 -140 0 0 406 0 406 23 -14 c12 -8 40 -21 62 -28 22 -7 57 -24 79 -37 55 -35 240 -98 257 -87 4 2 10 0 13 -5 14 -21 295 -37 406 -22 151 20 333 72 393 114 43 30 147 68 148 54 3 -62 4 -694 1 -734 l-4 -52 -151 -3 -152 -3 -3 -74 c-3 -69 -1 -76 24 -102 l28 -29 193 0 c154 0 200 3 223 15 61 32 60 21 60 618 l0 544 23 25 c151 167 251 308 299 421 16 40 39 91 49 113 49 110 83 290 95 504 7 119 8 120 107 197 31 24 57 50 57 57 0 7 27 44 60 82 33 38 63 80 66 94 4 14 18 41 33 60 29 38 141 232 141 244 0 4 25 59 55 121 30 63 55 117 55 120 0 3 8 24 19 48 10 23 29 76 41 117 13 41 28 84 35 96 7 11 21 49 31 85 10 35 29 93 42 129 48 132 54 162 55 290 1 142 -9 190 -53 238 -75 82 -188 102 -321 58 -91 -30 -223 -88 -304 -134 -91 -52 -124 -74 -128 -85 -3 -7 -23 -19 -46 -27 -22 -7 -49 -22 -58 -33 -10 -10 -27 -23 -38 -27 -11 -5 -62 -40 -114 -79 -84 -63 -167 -150 -230 -238 -12 -18 -31 -33 -41 -33 -10 0 -40 18 -66 41 -47 38 -220 129 -247 129 -7 0 -17 4 -23 9 -8 8 -160 51 -194 56 -8 1 -24 5 -35 10 -11 5 -114 10 -230 10 -219 0 -293 -3 -310 -14 -5 -4 -23 -8 -40 -10 -35 -4 -231 -68 -260 -85 -11 -7 -39 -18 -62 -24 -22 -7 -63 -27 -90 -45 -73 -50 -78 -51 -114 -9 -36 41 -200 178 -279 232 -28 19 -73 52 -101 73 -28 20 -56 37 -63 37 -6 0 -51 27 -100 60 -49 33 -98 62 -108 66 -10 3 -18 9 -18 14 0 4 -12 11 -27 15 -16 3 -47 15 -70 26 -24 10 -62 28 -86 38 -112 51 -236 65 -307 34z m3934 -209 c16 -22 18 -37 12 -98 -7 -88 -10 -109 -18 -121 -3 -6 -9 -26 -12 -45 -4 -19 -11 -46 -16 -60 -5 -14 -16 -52 -26 -85 -10 -33 -23 -69 -30 -80 -6 -11 -17 -45 -24 -75 -7 -30 -18 -65 -26 -77 -8 -12 -14 -29 -14 -36 0 -8 -20 -55 -45 -106 -25 -50 -45 -96 -45 -101 0 -17 -78 -176 -113 -231 -19 -30 -48 -81 -65 -115 -17 -33 -41 -73 -54 -88 -66 -79 -77 -90 -78 -76 -2 37 -35 238 -43 260 -3 8 -11 33 -17 55 -7 22 -35 90 -63 150 -41 90 -68 130 -144 220 -51 61 -93 116 -93 123 0 31 43 92 105 147 36 33 79 72 95 87 16 15 46 35 67 43 21 9 49 26 63 39 31 28 123 86 137 86 6 0 33 15 61 33 111 72 172 106 197 107 11 1 52 16 90 35 39 18 72 34 75 34 3 0 13 -11 24 -25z m-3733 -14 c41 -16 77 -30 82 -30 4 0 51 -26 105 -57 53 -31 124 -70 157 -87 33 -17 94 -56 135 -87 42 -31 87 -62 100 -69 44 -23 153 -120 224 -199 18 -20 18 -21 -37 -81 -31 -33 -68 -77 -83 -98 -15 -20 -42 -53 -59 -72 -18 -19 -40 -57 -50 -84 -10 -27 -28 -65 -41 -83 -12 -19 -26 -48 -30 -66 -3 -18 -17 -54 -29 -82 -23 -50 -53 -185 -57 -260 l-3 -40 -35 48 c-19 27 -47 63 -61 80 -15 18 -30 43 -34 57 -4 14 -31 66 -61 116 -30 51 -54 95 -54 99 0 4 -7 21 -15 38 -8 18 -24 57 -35 87 -12 30 -26 60 -32 67 -5 7 -21 43 -35 80 -35 95 -74 206 -77 218 -1 6 -7 20 -14 32 -7 12 -15 44 -19 70 -3 26 -9 53 -13 58 -4 6 -22 68 -40 138 -32 130 -34 175 -7 218 16 26 33 24 118 -11z m2079 -416 c153 -37 231 -66 334 -125 117 -67 180 -116 261 -204 73 -78 185 -224 185 -241 0 -12 34 -96 51 -127 9 -17 41 -138 60 -227 10 -46 14 -448 5 -457 -3 -3 -18 6 -33 21 -89 83 -124 103 -219 126 -119 29 -198 19 -314 -38 -44 -21 -132 -104 -150 -140 -8 -15 -19 -34 -26 -42 -42 -55 -57 -221 -29 -317 20 -66 31 -87 85 -156 93 -120 287 -184 438 -144 31 8 28 -3 -13 -43 -19 -19 -35 -41 -35 -49 0 -24 -180 -190 -278 -257 -52 -35 -112 -69 -135 -75 -23 -6 -46 -14 -52 -18 -17 -13 -130 -51 -178 -60 l-45 -8 21 41 c12 23 27 47 34 54 7 7 13 19 13 27 0 7 7 26 15 41 28 54 37 129 25 191 -21 101 -127 201 -230 219 -65 10 -123 12 -135 4 -5 -3 -21 -7 -33 -8 -70 -3 -188 -112 -209 -191 -7 -25 -13 -61 -13 -79 0 -63 38 -167 86 -237 19 -27 18 -55 -3 -55 -16 0 -108 31 -233 78 -56 21 -167 93 -239 155 -30 26 -58 47 -61 47 -4 0 -23 21 -44 47 -20 27 -59 77 -87 112 -27 35 -48 65 -46 67 2 3 17 0 33 -6 71 -27 213 -1 306 57 21 13 42 23 46 23 10 0 102 114 102 125 0 4 8 19 19 33 48 68 53 273 8 354 -38 70 -43 77 -78 116 -94 102 -188 146 -314 146 -102 0 -207 -34 -250 -79 -21 -23 -87 -67 -92 -62 -8 9 -9 346 -1 405 17 119 39 198 85 300 12 29 23 57 23 63 0 18 29 67 67 112 21 25 52 64 68 87 36 51 138 151 185 184 117 80 199 126 263 146 39 13 77 26 82 30 11 8 73 23 77 19 2 -1 12 3 23 9 20 10 42 14 165 33 96 14 294 1 410 -27z m-1049 -1448 c54 -19 116 -74 133 -117 18 -45 20 -108 5 -162 -12 -45 -79 -112 -127 -128 -52 -17 -130 -6 -195 26 -71 36 -87 65 -95 163 -4 64 -2 79 18 115 25 45 28 47 99 89 51 30 105 35 162 14z m1686 -12 c99 -52 123 -88 123 -182 0 -47 -25 -129 -47 -154 -40 -44 -180 -89 -209 -66 -7 5 -16 7 -20 6 -5 -2 -33 12 -62 30 -114 70 -136 228 -43 320 73 73 173 91 258 46z m-878 -739 c34 -17 41 -32 41 -93 0 -59 -17 -93 -53 -105 -41 -13 -75 -1 -97 36 -25 40 -25 86 -3 126 29 49 65 61 112 36z m-976 -234 l27 -33 0 -484 0 -484 -267 0 c-193 0 -275 4 -292 13 -45 22 -108 111 -120 169 -24 112 -15 285 17 368 5 14 9 27 9 30 0 3 9 23 20 45 12 22 26 58 32 80 18 67 137 226 221 296 41 34 78 66 81 71 3 5 34 23 70 42 l64 33 55 -57 c30 -31 67 -71 83 -89z'/></g></svg> </a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://yishiashia.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://yishiashia.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://yishiashia.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      使用 WebAuthn 實作無密碼驗證與 Passkey 介紹
    </h1>
    <div class="post-meta"><span title='2022-11-15 16:22:57 +0800 CST'>November 15, 2022</span>&nbsp;·&nbsp;4 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#passkey" aria-label="Passkey">Passkey</a></li>
                <li>
                    <a href="#fido2-%e8%88%87-webauthn" aria-label="FIDO2 與 WebAuthn">FIDO2 與 WebAuthn</a><ul>
                        
                <li>
                    <a href="#%e8%a7%92%e8%89%b2%e8%88%87%e8%aa%aa%e6%98%8e" aria-label="角色與說明">角色與說明</a></li>
                <li>
                    <a href="#attestation-register" aria-label="Attestation (Register)">Attestation (Register)</a></li>
                <li>
                    <a href="#assertion-%e8%aa%8d%e8%ad%89" aria-label="Assertion (認證)">Assertion (認證)</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%b5%90%e8%aa%9e-%e5%be%9e-fido2--webauthn-%e5%88%b0-passkey" aria-label="結語: 從 FIDO2 / WebAuthn 到 Passkey">結語: 從 FIDO2 / WebAuthn 到 Passkey</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Google、Apple、微軟及數百間科技公司或服務商在今年 (2022) 不約而同的表態支持 FIDO 聯盟與 W3C 所主推的<strong>通用無密碼登入標準 (common passwordless sign-in standard)</strong>，希望能透過例如指紋、Face ID等認證手段替代原本的密碼登入機制，提供用戶在網頁登入時一個更安全、防網路釣魚、即時交易驗證的登入方式。</p>
<p>Google 在今年10月上旬宣布在 Android 及 Chrome 導入 Passkey 無密碼認證機制，而 Apple 也將在 iOS 16 和 macOS Ventura 引入 Passkey ，透過掃描 QR Code 加上藍芽或其他裝置通訊技術，讓你可以透過手機的 Touch ID 或 Face ID 就可以登入你所有的電腦、平板等裝置。</p>
<p>下面我們會先說明需要使用密碼跟無密碼認證使用的場景，再深入介紹實務上使用 FIDO2 進行註冊與認證 (含範例程式)，最後再總結 FIDO2 / WebAuthn 與 Passkey 的關係 。</p>
<p><img loading="lazy" src="/images/0_1zYBySFcoREDdevX.jpeg" alt="hero"  />

<em>Photo by <a href="https://unsplash.com/@moneyphotos">regularguy.eth</a> on <a href="https://unsplash.com/">Unsplash</a></em></p>
<hr>
<p>通常需要用到 ”密碼” 或 ”認證” 的場合，像是在電商網站買東西、下訂單最後要結帳的時候會請你輸入帳號、密碼做登入(不登入的話也可能會要求你透過手機簡訊驗證碼做實名制驗證)，可以用以確保您在真實世界的身分。</p>
<p>在資訊安全的領域中，不管是<strong>帳號密碼</strong>或是<strong>手機簡訊驗證碼</strong>的驗證，都是屬於 <strong>挑戰回應(Challenge/Response)</strong> 的方法。</p>
<p><strong>挑戰回應</strong> 的方法具體來說，是指由正在溝通的兩方其中之一發起一個 <strong>挑戰 (Challenge)</strong>，而另一方提供一個正確可被驗證的<strong>合法答案 (Response)</strong>。</p>
<p>最常見的使用情境就是使用密碼驗證，比方說在電商網站購物前送出訂單之前請買家在網頁上再輸入一次密碼，如果密碼正確 (Valid response) ，則可以確認是由本人進行的操作。</p>
<p>但使用密碼作為驗證手段所衍生出的資安議題非常多，比方說網站管理者可能為了安全性而要求用戶使用的密碼複雜度必須足夠，但過於複雜的密碼常常會讓使用者記不起來，所以就寫在便條紙、記在手機備忘錄或存在檔案中，造成密碼洩漏的問題，而這也是 Apple, Google 及 Microsoft 三大廠商都主推無密碼認證的原因之一。</p>
<p>而在Web端要達到去密碼化，主要使用的解決方案還是透過 <strong>W3C</strong> 與 <strong>FIDO</strong> 聯盟所提出的 Web Authentication API (aka WebAuthn) 規範，而 WebAuthn 主要是使用密碼學中的非對稱性演算法與公私鑰取代密碼來進行訊息保密與驗證來完成 Challenge / Response 的機制。</p>
<p>使用者在 APP 或瀏覽器端會產生一組公/私鑰，私鑰會保留在使用的裝置上(如瀏覽器或手機裝置的 keychain 中)，而公鑰會透過 Attestation 的流程註冊到網站伺服器端，網站伺服器收到後會儲存下來，後續在跟用戶端進行訊息傳送時就會使用這對公/私鑰來進行訊息保密與驗證。</p>
<blockquote>
<p>註: 想了解關於非對稱式加密演算法或公/私鑰的概念，可以參考:</p>
<p><a href="/posts/introduction-to-basic-cryptography/">簡易密碼學介紹</a></p>
</blockquote>
<hr>
<h2 id="passkey">Passkey<a hidden class="anchor" aria-hidden="true" href="#passkey">#</a></h2>
<p>由三大巨頭主推的 Passkey 讓您可以透過您現在解鎖手機的方法，像是 Touch ID、Face ID 等方式來登入網站或 App。</p>
<p>您只需要使用您的生物特徵或PIN碼來啟動裝置上的Authenticator(認證器)，就可以透過安全的密碼簽章來跟網站伺服器溝通，取代原本使用的密碼，就像把家裡的大門從傳統鑰匙的鎖頭換成可以用指紋辨識的電子鎖一樣，不用再帶著鑰匙(密碼)出門了。</p>
<p>而 <strong>Passkey</strong> 主要是奠基於 <strong>FIDO聯盟</strong> 與 <strong>W3C</strong> 所主推的 <strong>FIDO2</strong> 與 <strong>WebAuthn 認證流程</strong>，基於這套認證機制，加上了像是掃描 QR Code 等方式，讓您可以使用儲存在手機上的私鑰 (或 credential) ，跨平台登入電腦PC上的網頁，這種跨平台的便利方式相信可以提升原本FIDO2無密碼驗證的使用者體驗，讓無密碼驗證越來越普及。</p>
<p>接下來，就讓我們來介紹一下 FIDO2 與 WebAuthn 吧。</p>
<hr>
<h2 id="fido2-與-webauthn">FIDO2 與 WebAuthn<a hidden class="anchor" aria-hidden="true" href="#fido2-與-webauthn">#</a></h2>
<p>FIDO2是一個去密碼化的認證流程，可以透過裝置上的Authenticator (例如: Touch ID、Face ID 或 USB金鑰)授權後，再經由瀏覽器中的 WebAuthn API 來使用裝置中儲存的私鑰來與網站伺服器端進行註冊或訊息驗證。</p>
<p><img loading="lazy" src="1_EdDw4nOhGopw7wsbGaDNgg.webp" alt="FIDO2 / WebAuthn 認證流程"  />

<em>FIDO2 / WebAuthn 認證流程</em></p>
<h3 id="角色與說明">角色與說明<a hidden class="anchor" aria-hidden="true" href="#角色與說明">#</a></h3>
<ol>
<li><strong>Authenticator</strong>: 基於密碼學的身分驗證器，像是智慧型手機或USB金鑰等，依照金鑰儲存特性可以區分為 <strong>platform</strong> 與 <strong>cross-platform</strong> 兩種，platform 身分驗證器是內嵌在裝置內，比如像是智慧型手機的 Touch ID 或 Face ID 等，而 cross-platform 的身分驗證器則是可以跨裝置使用的，比如像是 USB 金鑰。</li>
<li><strong>WebAuthn API</strong>: 在支援 WebAuthn 的瀏覽器上，我們可以透過 JavaScript 來呼叫 WebAuthn API，WebAuthn API 在收到 來自後端伺服器的挑戰 (challenge) 後，就會透過 CTAP (Client to Authenticator Protocol) 來請求身分驗證器簽署 challenge 並產生合法的回應 (signed assertion) ，後端伺服器收到這個回應後，透過先前註冊的公鑰進行解密與驗證，如果驗證成功即可允許用戶登入或進行操作。</li>
<li><strong>User</strong>: 金鑰的擁有者，在網站透過 WebAuthn API 存取金鑰時，會需要擁有者進行授權的動作，在上面的流程圖中是透過用戶輸入 PIN 碼來取用身分驗證器中的金鑰進行簽署，而其他像是 Touch ID 或 Face ID 也會需要用戶在進行挑戰/回應時刷一下指紋或臉，都是在請求使用者進行授權取用身分驗證器。</li>
<li><strong>Relying party</strong>: 用戶註冊與驗證的後端網站伺服器，用戶註冊時提供的公鑰會儲存在這個伺服器中。</li>
</ol>
<h3 id="attestation-register">Attestation (Register)<a hidden class="anchor" aria-hidden="true" href="#attestation-register">#</a></h3>
<p>Attestation 在 WebAuthn 的流程中代表的是 Authenticator 金鑰產生並註冊到後端 Relying party 的過程，簡易的流程如下:</p>
<ol>
<li>後端 Relying party (網站伺服器) 產生一組隨機、一次性的 challenge bytes (32 bytes) ，傳送到前端瀏覽器的網頁中。</li>
<li>前端的 JavaScript 程式收到 challenge 後，透過 WebAuthn API 存取裝置中或跨裝置的 Authenticator 產生一組 credential (內含一對公/私鑰)，並得到一個 <strong>Attestation</strong> 物件資料，Attestation 物件中包含簽署 challenge 後的 <strong>Assertion</strong> 資料與公鑰 (<strong>public key</strong>) 。</li>
<li>前端 JS 程式將 <strong>Attestation</strong> 資料回傳給後端伺服器 (Relying party) ，伺服器收到後使用公鑰驗證簽署後的 Assertion 資料，確認 challenge 一致後，即可將用戶的公鑰儲存下來，並與用戶的帳號 ID (依網站規劃，通常可以使用手機或email做用戶實名制帳號 ID) 做連結。</li>
</ol>
<p>範例程式如下:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">doRegister</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">publicKeyCredential</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">publicKey</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rp</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;example-org&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 這邊放使用者相關的資料 (後續會註冊在 authenticator 中，關聯到對應的一組 credential)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;edd1f115-6198-11ed-a902-0242ac1d0103&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;bob@example.org&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">displayName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Bob&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pubKeyCredParams</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;public-key&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">alg</span><span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">authenticatorSelection</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">authenticatorAttachment</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;platform&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">attestation</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;direct&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">timeout</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">60000</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">challenge</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 註: 這邊需要從後端伺服器產生一組本次登入使用的一次性 challenge bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//     以防止釣魚攻擊，不可以寫死
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0xDC</span>, <span style="color:#ae81ff">0x69</span>, <span style="color:#ae81ff">0xDD</span>, <span style="color:#ae81ff">0xBA</span>, <span style="color:#ae81ff">0xB0</span>, <span style="color:#ae81ff">0xBF</span>, <span style="color:#ae81ff">0x3A</span>, <span style="color:#ae81ff">0x9B</span>, <span style="color:#ae81ff">0xDB</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x84</span>, <span style="color:#ae81ff">0x2D</span>, <span style="color:#ae81ff">0x6F</span>, <span style="color:#ae81ff">0x29</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0xE1</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0xB6</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x14</span>, <span style="color:#ae81ff">0x74</span>, <span style="color:#ae81ff">0x95</span>, <span style="color:#ae81ff">0x4B</span>, <span style="color:#ae81ff">0x56</span>, <span style="color:#ae81ff">0x28</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x2F</span>, <span style="color:#ae81ff">0xFD</span>
</span></span><span style="display:flex;"><span>      ]).<span style="color:#a6e22e">buffer</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;透過CTAP取得簽署後的assertion資料為: &#34;</span>, <span style="color:#a6e22e">publicKeyCredential</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 當使用者點下註冊按鈕時，執行 doRegister 函式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">button</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;register-btn&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">button</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;click&#39;</span>, <span style="color:#a6e22e">doRegister</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>說明:</p>
<p>透過使用 <strong>Credential Management API</strong>，我們可以存取裝置上或外部跨裝置的 Authenticator 來產生一組金鑰 credential。</p>
<p>在上面的範例中，我們呼叫了 <em>navigator.credentials.create ()</em> 這個函式，並注入了金鑰產製的相關參數，包含 rp、user、pubKeyCredParams、authenticatorSelection、challenge 與 timeout。</p>
<ul>
<li><strong>rp</strong> 代表 Relying party ，也就是網站或服務的資訊。</li>
<li><strong>user</strong> 是使用者相關的資訊，包含 id、name 與 displayName，後續在認證過程中會顯示在選單中，讓使用者可以選擇要用哪個身份登入網站。</li>
<li><strong>pubKeyCredParams</strong> 設定 rp 支援的非對稱式金鑰加密演算法列表，裝置authenticator 會在此列表中找尋適合的演算法並產生對應的金鑰。</li>
<li><strong>authenticatorSelection.authenticatorAttachment</strong> 可以指令認證器的形式，您可以選擇 platform / cross-platform，如果使用 platform authenticator 就可以啟用像是 Touch ID 或 Face ID 等裝置內建的認證器，而如果選擇 cross-platform 的話，手機或電腦就會嘗試去尋找是否已經有外接的硬體認證器 (像是 USB硬體認證器)。</li>
<li><strong>challenge</strong> 是由後端伺服器 (Relying party) 所產生的一次性的驗證 token (長度是32 bytes) ，在驗證發生的當下由 Relying party 隨機產生並暫存下來，等後續前端透過認證器簽署完成回傳給 RP，RP端可以使用公鑰進行驗證 (避免 phishing) 。</li>
</ul>
<h3 id="assertion-認證">Assertion (認證)<a hidden class="anchor" aria-hidden="true" href="#assertion-認證">#</a></h3>
<p>完成註冊程序以後，在同一個裝置瀏覽這個網站時，即可透過儲存在裝置中的進行登入或交易驗證，簡易的流程如下:</p>
<ol>
<li>後端收到使用者需要進行驗證的交易請求，產生一組跟本次交易有關的一次性隨機的 challenge bytes (32 bytes) ，並傳送到前端網頁中。</li>
<li>前端 JavaScript 程式收到 challenge 後，透過 WebAuthn API 存取裝置中或跨裝置的 Authenticator 中的 credential 私鑰對 challenge bytes 進行簽署並產生 assertion 資料物件。</li>
<li>將 assertion 物件送到後端伺服器 (Relying party) ，後端伺服器透過儲存的公鑰對 assertion 進行驗證，如驗證無誤即可批准本次交易或登入動作。</li>
</ol>
<p>範例程式如下:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">doLogin</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">publicKeyCredential</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">get</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">publicKey</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rp</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;example-org&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">timeout</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">60000</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">challenge</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 註: 這邊需要從後端伺服器產生一組本次登入使用的一次性 challenge bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//     以防止釣魚攻擊，不可以寫死
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0xDC</span>, <span style="color:#ae81ff">0x69</span>, <span style="color:#ae81ff">0xDD</span>, <span style="color:#ae81ff">0xBA</span>, <span style="color:#ae81ff">0xB0</span>, <span style="color:#ae81ff">0xBF</span>, <span style="color:#ae81ff">0x3A</span>, <span style="color:#ae81ff">0x9B</span>, <span style="color:#ae81ff">0xDB</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0x9F</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x84</span>, <span style="color:#ae81ff">0x2D</span>, <span style="color:#ae81ff">0x6F</span>, <span style="color:#ae81ff">0x29</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0xE1</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0xB6</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0x14</span>, <span style="color:#ae81ff">0x74</span>, <span style="color:#ae81ff">0x95</span>, <span style="color:#ae81ff">0x4B</span>, <span style="color:#ae81ff">0x56</span>, <span style="color:#ae81ff">0x28</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x2F</span>, <span style="color:#ae81ff">0xFD</span>
</span></span><span style="display:flex;"><span>      ]).<span style="color:#a6e22e">buffer</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allowCredentials</span><span style="color:#f92672">:</span> []  <span style="color:#75715e">// 如果有先前登入的session資料，可以將使用者相關的金鑰列在這邊，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                            <span style="color:#75715e">// 裝置在認證時就不會跳出太多金鑰讓使用者眼花撩亂
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;透過CTAP取得簽署後的assertion資料為: &#34;</span>, <span style="color:#a6e22e">publicKeyCredential</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 當使用者點下登入按鈕時，執行 doLogin 函式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">button</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;login-btn&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">button</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;click&#39;</span>, <span style="color:#a6e22e">doLogin</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>說明:</p>
<p>在認證的流程中同樣使用 <strong>Credential Management API</strong> 來存取裝置上或外部跨裝置的 Authenticator 並簽署 RP 所給的 challenge 參數。</p>
<p>在上面的範例中，我們呼叫了 <em>navigator.credentials.get()</em> 這個函式，並注入了相關參數，包含 rp、challenge 與 allowCredentials 等。</p>
<ul>
<li><strong>allowCredentials</strong> 是允許使用的 credentials 列表，通常在用戶先前已經登入過但登入 session 已經逾期時，讓用戶再次登入使用，透過這個列表可以限縮用戶可以使用的金鑰，讓用戶在認證時可以簡單的選到想要的登入帳號或身分。</li>
</ul>
<hr>
<h2 id="結語-從-fido2--webauthn-到-passkey">結語: 從 FIDO2 / WebAuthn 到 Passkey<a hidden class="anchor" aria-hidden="true" href="#結語-從-fido2--webauthn-到-passkey">#</a></h2>
<p>前面提到了 WebAuthn 的註冊與驗證流程，可以發現在現行的 FIDO2 / WebAuthn 的使用上，必須在每個裝置上都註冊一組金鑰 (platform credential) ，但如果使用的是公用電腦或裝置，使用者不會想在上面註冊一組 platform credential 。</p>
<p>這時就得使用跨平台的認證器裝置，像是 USB金鑰 或是其他硬體認證器裝置，除了攜帶不便，也需要這個硬體認證器裝置相容於每台裝置，所以 FIDO2/WebAuthn 在使用上一直沒有很普及。</p>
<p>為了解決使用者體驗不佳的問題並推廣無密碼驗證，包含 Google、Apple及微軟還有其他上百家企業都積極投入 Passkey 這項新的認證機制，而 Passkey 主要就是希望透過瀏覽器、作業系統之間的溝通達到跨平台存取 platform credential，解決目前 FIDO2 / WebAuthn 在實務上使用的痛點。</p>
<p>相信在不久的未來，我們就可以真正拋棄密碼認證方式，使用更安全方便的無密碼認證方法。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on x"
        href="https://x.com/intent/tweet/?text=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9&amp;url=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z"/>
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f&amp;title=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9&amp;summary=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9&amp;source=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f&title=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on whatsapp"
        href="https://api.whatsapp.com/send?text=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9%20-%20https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on telegram"
        href="https://telegram.me/share/url?text=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9&amp;url=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 使用 WebAuthn 實作無密碼驗證與 Passkey 介紹 on ycombinator"
        href="https://news.ycombinator.com/submitlink?t=%e4%bd%bf%e7%94%a8%20WebAuthn%20%e5%af%a6%e4%bd%9c%e7%84%a1%e5%af%86%e7%a2%bc%e9%a9%97%e8%ad%89%e8%88%87%20Passkey%20%e4%bb%8b%e7%b4%b9&u=https%3a%2f%2fyishiashia.github.io%2fposts%2fpasskey-and-webauthn-passwordless-authentication%2f">
        <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
            <path
                d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
        </svg>
    </a>
</div>

  </footer><div id="disqus_thread"></div>
<script>
  

  

  (function () {
    
    var d = document,
      s = d.createElement("script");
    s.src = "https://yishiashia-blog.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
</article>
    </main>
    
<footer class="footer">
    <span>© 2023. Content on this site is licensed under a CC BY 4.0 license.</span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
